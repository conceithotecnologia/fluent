/**
   Prepara inserção da etiqueta

	@author    Ricardo Gonçalves
	@date      06/12/2011 20:41:06
	@trigger   B32 IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
   
   13/12/2011 19:22:13  v2    Ricardo Gonçalves.
      [+] Cálculo automático da data de devolução do comodato.
*/
CREATE OR REPLACE FUNCTION mc_00353####???()
  RETURNS trigger AS
$$
Declare
   re ender;
BEGIN
   if tg_op <> 'DELETE' then
      -- Prepara campos para inserção
      if tg_op = 'INSERT' then
         new.b32_emi_d := localtimestamp;

         if new.codtable is null then
            new.codtable := 'B32';
            new.b32_recno := new.recno;
         end if;
      else

      end if;

      -- Preenche validade do comodato
      if new.b32_validade is null then
         -- Obtem endereço do cliente
         re := mc_00208####???(new.a1_codcli, mc_00205####???(new.a1_codcli));

         -- Atualiza data de devolução do comodato
         select current_date + z7_diasret
           into new.b32_validade
           from [(sz7)] sz7
          where sz7.z7_uf = re.uf;
      end if;

      return new;
   else
      raise '[[A tabela de etiquetas (comodato) não admite exclusões.]]';
      return old;
   end if;
END;
$$
  LANGUAGE 'plpgsql' VOLATILE;
