/**
   Validação de requisição cotação

	@author    Gabriel Montes
	@date      21/05/2013 10:38:00
	@trigger   A3V B IUD

	Histórico  
   
   - 27/05/2013 12:05:00: Atualização da trigger. Verifica se quem está cotando tem permissão para cotar (se tem login ativo, se é comprador e se é responsável pelo requisitante).
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
   
   04/06/2013 10:13:00  v2  Gabriel Montes
      [+] Validação da relação entre Limite do aprovador x Valor da cotação

   27/06/2013 13:46:00  v3  Gabriel Montes
      [+] Validação alterada. A validação agora é feita a partir do grupo de materiais ou serviços, 
            previamente cadastrados nos grupos de solicitantes,supervisores,compradores,aprovadores.   
            
   03/09/2013 16:00:00  v4  Gabriel Montes
      [-] Correção da validação de supervisores e compradores.
      
   30/10/2013 17:34:00  v5  Gabriel Montes
      [+] Adicionado validação de cotações para itens que já estão sendo cotados pelo outro modelo de cotação
*/

CREATE OR REPLACE FUNCTION mc_00486####???()
Returns trigger
as $$
DECLARE
   r     record;
Begin 

   if (tg_op = 'DELETE') then 
      if (select sh8_estado 
            from [(sh8)] sh8
           where recno = old.a3u_recno) = 3 
         or
         (select sh8_estado 
            from [(sh8)] sh8
           where recno = old.a3u_recno) = 4
      then

         select sfj.sfj_pessoa, sfj.sfj_nome
           into r
           from [(a2k)] a2k 
               join [(sfj)] sfj
                 on sfj.sfj_pessoa = a2k.sfj_pessoa             
         where a2k.sfj_pessoa = ck_00009####???(sys_user####???()); 

          -- Se for um material
         if (select sh8_tipo 
               from [(sh8)] sh8
         where sh8.a3u_recno = old.a3u_recno
           and sh8.sh8_item = old.sh8_item) = 1
         then
            -- Compara o material requisitado com o itens que o comprador pode aprovar.
            if not exists(
            select shi.shi_codpro
              from [(shi)]  shi
                  join [(sh8)] sh8   
                    on sh8.shi_codpro = shi.shi_codpro
                  join [(a3u)] a3u
                    on  a3u.recno = sh8.a3u_recno
           where sh8.a3u_recno = old.a3u_recno
           and sh8.sh8_item = old.sh8_item
         intersect(           
            select sha.shi_codpro
              from [(sha)] sha 
	               join [(a3s)] a3s
                    on sha.a3w_recno = a3s.a3w_recno
                  join [(a2k)] a2k
                    on a2k.sfj_pessoa = a3s.sfj_pessoa
                  join [(a3w)] a3w
                    on a3w.recno = a3s.a3w_recno  
              where a2k.coduser = sys_user####???()
                and a3w.a3w_estado = 1
                and a3s.a3s_situacao = 1
         union
            select shi.shi_codpro
              from [(shi)] shi
                  join [(sh0)] sh0
                    on shi.b4_codfam = sh0.b4_codfam
                  join [(a3s)] a3s
                    on sh0.a3w_recno = a3s.a3w_recno
                  join [(a2k)] a2k
                    on a2k.sfj_pessoa = a3s.sfj_pessoa
                  join [(a3w)] a3w
                    on a3w.recno = a3S.a3w_recno   
              where a2k.coduser = sys_user####???()
                and a3w.a3w_estado = 1
                and a3s.a3s_situacao = 1))
            then 
               raise '[[O usuário "%" não pode excluir esta cotação. Este material não está cadastrado no "grupo de materiais" que o usuário supervisiona.]]', sys_user####???();

         end if;
         
         -- Se for um serviço
            elsif (
               select sh8_tipo 
                 from [(sh8)] sh8
               where sh8.a3u_recno = old.a3u_recno
                 and sh8.sh8_item = old.sh8_item) <> 1 
            then
            if not exists(
               select sew_servico
                 from [(sh8)] sh8
               where sh8.a3u_recno = old.a3u_recno
                 and sh8.sh8_item = old.sh8_item
            intersect (
               select shb.sew_servico
                 from [(shb)] shb
                     join [(a3s)] a3s
                       on shb.a3w_recno = a3s.a3w_recno
                     join [(a2k)] a2k
                       on a2k.sfj_pessoa = a3s.sfj_pessoa
                     join [(a3w)] a3w
                       on a3w.recno = a3s.a3w_recno  
                 where a2k.coduser = sys_user####???()
                   and a3w.a3w_estado = 1
                   and a3s.a3s_situacao = 1
            union
               select sew.sew_servico
                 from [(sh4)] sh4
                     join [(a3s)] a3s
                       on sh4.a3w_recno = a3s.a3w_recno
                     join [(a2k)] a2k
                       on a2k.sfj_pessoa = a3s.sfj_pessoa
                     join [(a3w)] a3w
                       on a3w.recno = a3s.a3w_recno   
                     join [(sew)] sew
                       on sew.sew_codfam = sh4.sew_codfam
                 where a2k.coduser = sys_user####???()
                   and a3w.a3w_estado = 1
                   and a3s.a3s_situacao = 1))
            then 
               raise '[[O usuário "%" não pode excluir esta cotação. Este serviço não está cadastrado no "grupo de serviços" que o usuário supervisiona.]]', sys_user####???();
            end if;
         end if;
      end if;
      
      return old;
   end if;

   if(tg_op = 'INSERT') then
      
      if exists(
         select 1 
           from [(sh8)] sh8
               join [(a3v)] a3v
                 on sh8.a3u_recno = new.a3u_recno
                and sh8.sh8_item  = new.sh8_item
          where SH8.sh8_cotmod = 2)
      then
         
         Perform sys_msg####???(1, 'Item já está em processo de cotação pelo Modelo Cotação x Fornecedor.' );
         
         return null;
      end if;
      
      new.a3v_emissao := current_timestamp;
      new.shk_prazodt := new.a3v_emissao + new.a3v_prazo * interval'1 day';
      new.shk_validadedt  := new.a3v_emissao + new.a3v_validade * interval'1 day';
      
      -- Insere o login do comprador e altera o estado do item para "Em cotação".
      update [(sh8)] sh8
        set coduser_comp  = sys_user####???(),
            sh8_estado    = 4,
            sh8_qtdcomp   = new.a3v_qtd,
            sh8_qtd       = new.a3v_qtd
      where sh8.a3u_recno = new.a3u_recno
        and sh8.sh8_item  = new.sh8_item;

      new.a3v_valortotal = new.a3v_valor*new.a3v_qtd;
      
   end if;
   
   if tg_op <> 'DELETE' then
      if
      ((select sh8_estado 
            from [(sh8)] sh8
         where sh8.a3u_recno = new.a3u_recno
           and sh8.sh8_item = new.sh8_item) between 3 and 4)
      then
      -- Insere o login do comprador e altera o estado do item para "Em cotação".
      update [(sh8)] sh8
        set coduser_comp  = sys_user####???(),
            sh8_estado    = 4,
            sh8_qtdcomp   = new.a3v_qtd,
            sh8_qtd       = new.a3v_qtd
      where sh8.a3u_recno = new.a3u_recno
        and sh8.sh8_item  = new.sh8_item;
      end if;
      
      new.a3v_valortotal = new.a3v_valor*new.a3v_qtd;
      if ( select sh8_tipo 
                 from [(sh8)] sh8
                where sh8.a3u_recno = new.a3u_recno
                  and sh8.sh8_item = new.sh8_item) <> 1
      then
         new.a3v_bse_ipi := 0;
         new.a3v_aliq_ipi := 0;
      end if;
      -- Se o item estiver no estado "Aguardando cotação" ou "Em cotação"
      if ((select a3u_estado
           from [(a3u)] a3u
          where a3u.recno = new.a3u_recno) = 3
          and 
         ((select sh8_estado 
            from [(sh8)] sh8
         where sh8.a3u_recno = new.a3u_recno
           and sh8.sh8_item = new.sh8_item) = 3 
         ))
      then
         -- Nova cotação
         select sfj.sfj_pessoa, sfj.sfj_nome
           into r
           from [(a2k)] a2k 
                join [(sfj)] sfj
                  on sfj.sfj_pessoa = a2k.sfj_pessoa             
          where a2k.sfj_pessoa = ck_00009####???(sys_user####???()); 

         -- Se for um material
         if (select sh8_tipo 
               from [(sh8)] sh8
         where sh8.a3u_recno = new.a3u_recno
           and sh8.sh8_item = new.sh8_item) = 1
         then
            -- Compara o material requisitado com o itens que o comprador pode aprovar.
            if not exists(
            select shi.shi_codpro
              from [(shi)]  shi
                  join [(sh8)] sh8   
                    on sh8.shi_codpro = shi.shi_codpro
                  join [(a3u)] a3u
                    on  a3u.recno = sh8.a3u_recno
            where sh8.a3u_recno = new.a3u_recno
           and sh8.sh8_item = new.sh8_item
         intersect(           
            select sha.shi_codpro
              from [(sha)] sha 
	               join [(a3s)] a3s
                    on sha.a3w_recno = a3s.a3w_recno
                  join [(a2k)] a2k
                    on a2k.sfj_pessoa = a3s.sfj_pessoa
                  join [(a3w)] a3w
                    on a3w.recno = a3s.a3w_recno  
              where a2k.coduser = sys_user####???()
                and a3w.a3w_estado = 1
                and a3s.a3s_situacao = 1
         union
            select shi.shi_codpro
              from [(shi)] shi
                  join [(sh0)] sh0
                    on shi.b4_codfam = sh0.b4_codfam
                  join [(a3s)] a3s
                    on sh0.a3w_recno = a3s.a3w_recno
                  join [(a2k)] a2k
                    on a2k.sfj_pessoa = a3s.sfj_pessoa
                  join [(a3w)] a3w
                    on a3w.recno = a3S.a3w_recno   
              where a2k.coduser = sys_user####???()
                and a3w.a3w_estado = 1
                and a3s.a3s_situacao = 1))
            then 
               raise '[[O usuário "%" não pode cotar este material. Este material não está cadastrado no "grupo de materiais" que o usuário supervisiona. [486] ]]', sys_user####???();
         end if;
         
         -- Se for um serviço
            elsif (
               select sh8_tipo 
                 from [(sh8)] sh8
                where sh8.a3u_recno = new.a3u_recno
                  and sh8.sh8_item = new.sh8_item) <> 1 
            then
            if not exists(
               select sew_servico
                 from [(sh8)] sh8
         where sh8.a3u_recno = new.a3u_recno
           and sh8.sh8_item = new.sh8_item
            intersect (
               select shb.sew_servico
                 from [(shb)] shb
                     join [(a3s)] a3s
                       on shb.a3w_recno = a3s.a3w_recno
                     join [(a2k)] a2k
                       on a2k.sfj_pessoa = a3s.sfj_pessoa
                     join [(a3w)] a3w
                       on a3w.recno = a3s.a3w_recno  
                 where a2k.coduser = sys_user####???()
                   and a3w.a3w_estado = 1
                   and a3s.a3s_situacao = 1
            union
               select sew.sew_servico
                 from [(sh4)] sh4
                     join [(a3s)] a3s
                       on sh4.a3w_recno = a3s.a3w_recno
                     join [(a2k)] a2k
                       on a2k.sfj_pessoa = a3s.sfj_pessoa
                     join [(a3w)] a3w
                       on a3w.recno = a3s.a3w_recno   
                     join [(sew)] sew
                       on sew.sew_codfam = sh4.sew_codfam
                 where a2k.coduser = sys_user####???()
                   and a3w.a3w_estado = 1
                   and a3s.a3s_situacao = 1))
            then 
               raise '[[O usuário "%" não pode cotar este serviço. Este serviço não está cadastrado no "grupo de serviços" que o usuário supervisiona.]]', sys_user####???();
            end if;
         end if;

         if (
            select sh8_tipo 
              from [(sh8)] sh8
             where sh8.a3u_recno = new.a3u_recno
               and sh8.sh8_item = new.sh8_item) <> 1 
               and new.a3v_ntremessa is null
         then
            raise '[[Campo "Gera nota de remessa?" não pode ser nulo para serviços.]]';
         end if;
      
         if (select sh8_tipo 
               from [(sh8)] sh8
              where sh8.a3u_recno = new.a3u_recno
                and sh8.sh8_item = new.sh8_item) = 1            
                AND new.a3v_ntremessa = 1
            then
               raise '[[Nota de remessa pode ser gerada apenas para serviços.]]';
         end if;

      end if;
   end if;
   
   return new;
END;
$$ Language 'plpgsql';