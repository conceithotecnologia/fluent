/**
   Validações dos Adiantamentos das notas fiscais de saída - FNQ

	@author    Gabriel Montes
	@date      15/08/2014  16:53:00
	@trigger   FNQ B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
*/
Create or Replace Function mc_00833####???()
Returns trigger
AS
$$
Declare
   iSerial        [(sai)].sai_serial%type;      -- Número serial da nota fiscal
   iAprovada      [(sai)].sai_financas%type;    -- Aprovação financeira da nota
Begin
   If tg_op <> 'DELETE' Then
      iSerial  := new.sai_serial;
      
      if exists(
         select 1
           from [(fnr)] fnr
          where fnr.sai_serial = iSerial
            and fnr.fnr_parce  = new.fnq_parce)
      then
         raise '[[Já existe uma parcela com este número de parcela.]]';
      end if;
      
   Else
      iSerial  := old.sai_serial;
   End If;
   -- Busca dados no cabecalho da nota fiscal
   Select sai_financas Into iAprovada
     From [(sai)]
    Where sai_serial = iSerial;

   If iAprovada > 0 Then
      raise '[[ATENÇÃO. Não é possível incluir, alterar ou excluir parcelas de uma nota que já gerou os títulos em contas a receber.]]';
   End If;
   If tg_op <> 'DELETE' Then
      Return new;
   Else
      Return old;
   End If;
End;
$$  language plpgsql;