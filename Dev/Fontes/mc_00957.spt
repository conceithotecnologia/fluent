/**
   Valida a seleção de lotes para a caldeação

	@author    Jurandy da Silva Costa
	@date      21/07/2026 14:00:00
	@trigger   SEN B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   21/07/2016 14:00:00  v1.0  Jurandy da Silva Costa
      [+] Implementação do procedimento de validação.

*/
Create or Replace Function mc_00957####???()
Returns trigger
As
$$
Declare
   nSaldo       [(sd3)].sd3_saldo%type;       -- Saldo do Lote
   nSd3_saldo   [(sd3)].sd3_saldo%type;
   nSd3_lote_ok integer;
Begin
   If tg_op <> 'DELETE' Then
      nSaldo := Coalesce((Select sd3_saldo From [(sd3)] Where sd3_lote = new.sd3_lote), 0);
      If tg_op = 'UPDATE' Then
         If new.sd3_lote = old.sd3_lote Then
            nSaldo := nSaldo + old.sen_quanto;
         End If;
      End If;
   
      select sd3_saldo,  sd3_lote_ok
        into nSd3_saldo, nSd3_lote_ok
        from [(sd3)]
       where sd3_lote = new.sd3_lote;
       
      if nSd3_saldo = 0.00 or nSd3_lote_ok = 0 then
         raise '[[ATENÇÂO. Lote sem saldo disponível ou medição fora do padrão.]]';
      end if;
      
      If new.sen_quanto > nSaldo then
         Raise '[[ATENÇÃO. Não é possível reservar um valor maior que o saldo atual do lote que é de: "%"]]', nSaldo;
      End If;
      Return new;
   Else   
      Return old;
   End If;
End;
$$
language plpgsql;