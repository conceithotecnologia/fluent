/*==============================================================================
| Empresa..: MultCont Informática                                              |
| Autor....: Fabio Carvalho                                                    |
| Data.....: 05/05/2008                                                        |
| Tipo.....: Stored Procedure                                                  |
| Descrição: Sugere o número da proxima NF de acordo com a serie informada     |
==============================================================================*/
Create or Replace Function mc_00130####???
( Out out_res Integer )
As $$
Declare
   -- variaveis de uso interno
   cSerieNF     [(sat)].at_serie%type;           -- Série da Nota Fiscal
   dDataEmi     [(sai)].sai_dtemissao%type;      -- Data de Emissão da NF

Begin
   out_res := 0;

   -- Recupera a série e a data de emissão a partir das notas selecionadas
   Select Max(sai.at_serie), Max(sai.sai_dtemissao)
     Into cSerieNF,          dDataEmi
     from [(sai)] sai
          Join [(ss029)] ss029 on sai.recno = ss029.recfile;

   -- Atribuo a série da nota como primeiro parâmetro
   update [(ss042)]
      set string_    = cSerieNF,
          enabled    = 0
    where session    = sys_session()
      and Columnname = 'param_1';

   -- Atribuo o próximo número de nota como segundo parâmetro
   update [(ss042)]
      set integer_   = coalesce((select at_curr from [(sat)] where at_serie = cSerieNF), 1)
    where session    = sys_session()
      and Columnname = 'param_2';

   -- Atribuo a data de emissão da nota como terceiro parâmetro
   update [(ss042)]
      set date_      = dDataEmi
    where session    = sys_session()
      and Columnname = 'param_3';

   out_res := 1;
end;
$$ language 'plpgsql'
