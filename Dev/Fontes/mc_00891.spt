/*
   F14 - Valida informações do cadastro de pessoas

   Autor	   Bárbara de Paula
   Data     13/02/2015 11:52:00 
   Trigger  F14 Before

	Histórico
	------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
   
  [+] - Data de admissão não poderá ser futura ao mês de inclusão;
  [+] - Antes de realizar uma nova matrícula, verificar se colaborador já foi rescindido;
*/
Create or Replace Function mc_00891####???()
Returns trigger
As $$

Begin
   if tg_op = 'DELETE' then
   
      if (extract (month from old.f14_dtadm)  ||'/'|| extract(year from old.f14_dtadm)) <> 
         (extract (month from current_date)   ||'/'|| extract(year from current_date))
      then 
         raise '[[ATENÇÃO.Exclusões só são permitidas no mês de admissão se não houver movimentações na base, caso contrário somente com rescisão.]]';
      end if;
      return old;
   end if;

   if tg_op = 'INSERT' then
   
      if extract (month from new.d_i) <  extract (month from new.f14_dtadm) 
      or extract (year  from new.d_i) <> extract (year  from new.f14_dtadm) 
      then
         --raise '[[ATENÇÃO. Data de Admissão tem que pertencer ao mês de inclusão.]]';
      end if;
      
      if exists(
         select 1
           from [(f14)] 
          where sfj_pessoa = new.sfj_pessoa 
            and f14_dtdemis is null) 
      THEN
         raise '[[ATENÇÃO.Este colaborador possui matrícula ativa]]';
      end if;    
   end if;
   return new;
End;
$$ language plpgsql;