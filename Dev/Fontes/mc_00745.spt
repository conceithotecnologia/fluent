/**
   Geração do arquivo de remessa CNAB 240 para os bancos 008 e 033 - Santander

	@author    Jurandy da Silva Costa
	@date      09/11/2009 21:15:00
	@trigger

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   20/11/2009 23:28:58  v1.1 Jurandy da Silva Costa.
      [*] Sem histórico.

   30/04/2011 12:00:00  v1.2  Jurandy da Silva Costa.
      [*] Inclusão da versão 4.0 do layout CNAB 240 do banco Santander

   25/08/2012 15:40:00  v1.3 Jurandy da Silva Costa;
      [*] Alterado o tipo do campo FR3.NNUMERO para Varchar(20)
*/
Create or Replace Function mc_00745####???
( In  cCodBanco   VarChar(03),
  In  cContaBco   VarChar(25),
  In  aDadosCNAB  VarChar ARRAY[26],
  Out out_res     Integer )
As $$

Declare
-- {Variáveis para cursores}
   xSelecao       refcursor;                      -- Cursor para Títulos selecionados
   rCobranca      record;                         -- Registro para o endereço de cobrança

-- {Variáveis de uso interno}
   iTitulo        [(fr3)].an_codtit%type;         -- Número do título selecionado
   iParcela       [(fr3)].an_parce%type;          -- Número da parcela do título
   nValor         [(fr3)].fr3_valor%type;         -- Valor do título
   dVencto        [(fr3)].fr3_vencto%type;        -- Vencimento do título
   dEmissao       [(fr3)].fr3_emissao%type;       -- Emissão do título
   cNumero        [(fr3)].fr3_nnumero%type;       -- Nosso Número
   iCliente       [(fr3)].a1_codcli%type;         -- Código do cliente
   iCarteira      [(fr3)].fr3_cobrar%type;        -- Código da carteira
   iRemessa       [(fbs)].fbs_remessa%type;       -- Número da remessa
   cNomeClie      [(sfj)].sfj_nome%type;          -- Nome do cliente
   cCNPJClie      [(sfh)].sfh_cnpj%type;          -- CNPJ do cliente
   cCPF_Clie      [(sfi)].sfi_cpf%type;           -- CPF  do cliente
   cSessao        [(fr3)].session%type;           -- Sessão atual do usuário
   sEspecie       [(san)].c015_cod%type;

   cExecute       Varchar;
   cTexto         Varchar;
   cTipoCNPJ      Varchar(01);
   cCNPJ_CPF      Varchar(15);
   cDocto         Varchar(20);
   cJuros         Varchar(15);
   cDesco         Varchar(08);
   cSpace50       Varchar(50);
   iOrdem         Integer;
   iLotes         Integer;
   iDoctos        Integer;
   nTotal         Numeric(15, 2);
   nMultaPerc     [(san)].an_multa_p%type;
   dMultadata     [(san)].an_d_multa%type;
   nMultaValor    [(san)].an_multa_c%type;
   nResul         integer;
   sDigito        varchar;
   iDigito        integer;
   i              integer;
   sCalculo       varchar;
   iNNumeroDc     integer;
Begin
   -- Inicializa variáveis
   out_res  := 0;
   iOrdem   := 0;
   iLotes   := 0;
   iDoctos  := 0;
   nTotal   := 0.00;
   cSpace50 := '                                                  ';
   -- Recupera a sessão do usuário
   cSessao := sys_session();

   -- Verifica se existem registros selecionados ainda não incluídos em nenhuma remessa
   If (Select Count(*) 
         From [(fr3)] 
        Where fr3_selecao = 1 
          And fbs_remessa Is Null) < 1 Then
      raise '[[ATENÇÃO. Todos os títulos selecionados já foram incluídos numa remessa. Favor selecionar outros títulos.]]';
   End If;

   -- Recupera o número da última remessa para este banco
   Select Coalesce(Max(fbs_remessa), 0) + 1
     Into iRemessa
     From [(fbs)]
    Where ak_cc = cContaBco;

   -- Inclui um registro na tabela de arquivos de remessa - FBS
   Insert Into [(fbs)] ( ak_cc,     fbs_remessa, fbs_status, fbs_data_g,        fbs_user_g,        fbs_doctos, fbs_total )
               Values  ( cContaBco, iRemessa,    1,          CURRENT_TIMESTAMP, sys_user####???(), iDoctos,    nTotal );

   -- Cursor com os títulos selecionados
   Open xSelecao For
        Select a.an_codtit,  a.an_parce,  a.fr3_valor,  a.fr3_emissao, a.fr3_vencto, a.a1_codcli, a.fr3_nnumero,
               a.fr3_cobrar, b.c015_cod,  b.an_multa_p, b.an_d_multa,  b.an_multa_c, b.an_nnumero_dc
          From [(fr3)] a
          join [(san)] b on b.an_codtit = a.an_codtit and b.an_parce = a.an_parce
         Where a.fr3_selecao = 1
           And a.fbs_remessa Is Null;

   Fetch xSelecao Into iTitulo, iParcela, nValor, dEmissao, dVencto, iCliente, cNumero, iCarteira, sEspecie,
                       nMultaPerc, dMultadata, nMultaValor, iNNumeroDc;

   -- Inclui o registro HEADER do arquivo de remessa
   iOrdem := iOrdem + 1;
   cTexto := cCodBanco;                                             -- 01.0 Código do Banco na Compensação
   cTexto := cTexto || '0000';                                      -- 02.0 Lote de Serviço
   cTexto := cTexto || '0';                                         -- 03.0 Tipo de Registro
   cTexto := cTexto || Substr(cSpace50, 1, 08);                     -- 04.0 Reservado para uso do Banco
   cTexto := cTexto || '2';                                         -- 05.0 Tipo de Inscrição da Empresa
   cTexto := cTexto || '0' || Substr(aDadosCNAB[13], 1, 14);        -- 06.0 Número de Inscrição da Empresa
   cTexto := cTexto || Substr(aDadosCNAB[11], 1, 15);               -- 07.0 Código do Convênio no Banco
   cTexto := cTexto || Substr(cSpace50, 1, 25);                     -- 08.0 Reservado para uso do Banco
   cTexto := cTexto || Substr(aDadosCNAB[14], 1, 30);               -- 09.0 Nome da Empresa
   cTexto := cTexto || Substr(aDadosCNAB[12], 1, 30);               -- 10.0 Nome do Banco
   cTexto := cTexto || Substr(cSpace50, 1, 10);                     -- 11.0 Reservado para uso do Banco
   cTexto := cTexto || '1';                                         -- 12.0 Código Remessa / Retorno
   cTexto := cTexto || To_Char(CURRENT_DATE, 'DDMMYYYY');           -- 13.0 Data de Geração do Arquivo
   cTexto := cTexto || Substr(cSpace50, 1, 06);                     -- 14.0 Reservado para uso do Banco
   cTexto := cTexto || Sys_Strzero(iRemessa, 06);                   -- 15.0 Número Seqüencial do Arquivo
   cTexto := cTexto || '040';                                       -- 16.0 Nro da Versão do Layout do Arquivo
   cTexto := cTexto || Substr(cSpace50, 1, 50);                     -- 27.0 Reservado para uso do Banco
   cTexto := cTexto || Substr(cSpace50, 1, 24);                     -- 27.0 Reservado para uso do Banco
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RHA',    cTexto,    240 );

   -- Inclui o registro HEADER do lote
   iOrdem := iOrdem + 1;
   cTexto := cCodBanco;                                             -- 01.1 Código do Banco na Compensação
   cTexto := cTexto || '0001';                                      -- 02.1 Lote de Serviço
   cTexto := cTexto || '1';                                         -- 03.1 Tipo de Registro
   cTexto := cTexto || 'R';                                         -- 04.1 Tipo da Operação
   cTexto := cTexto || '01';                                        -- 05.1 Tipo do Serviço
   cTexto := cTexto || '  ';                                        -- 06.1 Forma de Lançamento
   cTexto := cTexto || '030';                                       -- 07.1 Nº da Versão do Layout do Lote
   cTexto := cTexto || ' ';                                         -- 08.1 Reservado para uso do Banco
   cTexto := cTexto || '2';                                         -- 09.1 Tipo de Inscrição da Empresa
   cTexto := cTexto || '0' || Substr(aDadosCNAB[13], 1, 14);        -- 10.1 Número de Inscrição da Empresa
   cTexto := cTexto || Substr(cSpace50, 1, 20);                     -- 11.1 Reservado para uso do Banco
   cTexto := cTexto || Substr(aDadosCNAB[11], 1, 15);               -- 12.1 Código do Convênio no Banco
   cTexto := cTexto || Substr(cSpace50, 1, 05);                     -- 13.1 Reservado para uso do Banco
   cTexto := cTexto || Substr(aDadosCNAB[14], 1, 30);               -- 14.1 Nome da Empresa
   cTexto := cTexto || Substr(cSpace50, 1, 40);                     -- 15.1 Mensagem 1
   cTexto := cTexto || Substr(cSpace50, 1, 40);                     -- 16.1 Mensagem 2
   cTexto := cTexto || Sys_Strzero(iRemessa, 08);                   -- 17.1 Número Seqüencial da Remessa
   cTexto := cTexto || To_Char(CURRENT_DATE, 'DDMMYYYY');           -- 18.1 Data de Geração do Arquivo
   cTexto := cTexto || Substr(cSpace50, 1, 41);                     -- 19.1 Reservado para uso do Banco
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RHL',    cTexto,    240 );

   -- Inclui os registros selecionados na tabela de geração do arquivo texto - FR4
   While Found Loop
      -- Insere os registros detalhe na tabela temporária FR4
      iOrdem := iOrdem + 1;
      iLotes := iLotes + 1;
      cDocto := 'T' || Sys_Strzero(iTitulo, 6) || ' - P' || Sys_Strzero(iParcela, 2) || Substr(cSpace50, 1, 2);
      If aDadosCNAB[15] = '2' Or aDadosCNAB[15] = '6' Then
         cJuros := Sys_StrzeroDec(aDadosCNAB[16]::Numeric, 5, '', 15);
      Else
         cJuros := Sys_StrzeroDec(aDadosCNAB[16]::Numeric, 2, '', 15);
      End If;
      If aDadosCNAB[17] = '0' Then
         cDesco := '00000000';
      Else
         cDesco := To_Char(dVencto, 'DDMMYYYY');
      End If;
      -- Registro Detalhe - Segmento P (Obrigatório Remessa)
      cTexto := cCodBanco;                                             -- 01.3P Código do Banco na Compensação
      cTexto := cTexto || '0001';                                      -- 02.3P Lote de Serviço
      cTexto := cTexto || '3';                                         -- 03.3P Tipo de Registro
      cTexto := cTexto || Sys_Strzero(iLotes, 5);                      -- 04.3P Nº Seqüencial do Registro no Lote
      cTexto := cTexto || 'P';                                         -- 05.3P Código de Segmento do Reg. Detalhe
      cTexto := cTexto || ' ';                                         -- 06.3P Reservado para uso do Banco
      cTexto := cTexto || '01';                                        -- 07.3P Código de Movimento Remessa
      cTexto := cTexto || Substr(aDadosCNAB[01], 2, 04);               -- 08.3P Ag. Mantenedora da Cta do Favor.
      cTexto := cTexto || Substr(aDadosCNAB[02], 1, 01);               -- 09.3P Dígito Verificador da Agência
      cTexto := cTexto || Substr(aDadosCNAB[03], 1, 09);               -- 10.3P Número da Conta Corrente
      cTexto := cTexto || Substr(aDadosCNAB[04], 1, 01);               -- 11.3P Dígito Verificador da Conta
      cTexto := cTexto || Substr(aDadosCNAB[03], 1, 09);               -- 12.3P Número da Conta Cobrança
      cTexto := cTexto || Substr(aDadosCNAB[04], 1, 01);               -- 13.3P Dígito Verificador da Conta Cobrança
      cTexto := cTexto || '  ';                                        -- 14.3P Reservado para uso do Banco
      cTexto := cTexto || lpad(cNumero,12,'0')
                       || iNNumeroDc::varchar(1);                      -- 15.3P Identificação do Título no Banco (Nosso Número)
--      cTexto := cTexto || iCarteira::Varchar(1);                       -- 16.3P Tipo de Cobrança
      cTexto := cTexto || '5';                                         -- 16.3P Tipo de Cobrança
      cTexto := cTexto || Substr(aDadosCNAB[07], 1, 01);               -- 17.3P Forma de Cadastramento do Título no Banco
      cTexto := cTexto || Substr(aDadosCNAB[08], 1, 01);               -- 18.3P Tipo de Documento
      cTexto := cTexto || '  ';                                        -- 19.3P Reservado para uso do Banco
      cTexto := cTexto || cDocto;                                      -- 21.3P Número do Documento de Cobrança
      cTexto := cTexto || To_Char(dVencto, 'DDMMYYYY');                -- 22.3P Data de Vencimento do Título
      cTexto := cTexto || Sys_StrzeroDec(nValor, 2, '', 15);           -- 23.3P Valor Nominal do Título
      cTexto := cTexto || '0000';                                      -- 24.3P Agência Encarregada da Cobrança
      cTexto := cTexto || '0';                                         -- 25.3P Dígito Verificador da Agência
      cTexto := cTexto || ' ';                                         -- 26.3P Reservado para uso do Banco

      --Recupera a especie de Titulo
      cTexto := cTexto || (select coalesce(c015_santander,'02')
                             from [(c015)]
                            where c015_cod = sEspecie);               -- 27 - especie de Titulo
--      cTexto := cTexto || '02';                                        -- 27.3P Espécie do Título -- DUPLICATA MERCANTIL
      cTexto := cTexto || 'N';                                         -- 28.3P Identifica de Título Aceito/Não Aceito -- ACEITO
      cTexto := cTexto || To_Char(dEmissao, 'DDMMYYYY');               -- 29.3P Data da Emissão do Título
      cTexto := cTexto || Substr(aDadosCNAB[15], 1, 01);               -- 30.3P Código do Juros de Mora
      cTexto := cTexto || To_Char(dVencto, 'DDMMYYYY');                -- 31.3P Data do Juros de Mora
      cTexto := cTexto || cJuros;                                      -- 32.3P Juros de Mora por Dia/Taxa
      cTexto := cTexto || Substr(aDadosCNAB[17], 1, 01);               -- 33.3P Código do Desconto 1
      cTexto := cTexto || cDesco;                                      -- 34.3P Data do Desconto 1
      cTexto := cTexto || Sys_StrzeroDec(aDadosCNAB[18]::Numeric,
                                                        2, '', 15);    -- 35.3P Valor/Percentual a ser Concedido
      cTexto := cTexto || Sys_Strzero(0, 15);                          -- 36.3P Valor do IOF a ser Recolhido
      cTexto := cTexto || Sys_Strzero(0, 15);                          -- 37.3P Valor do Abatimento
      cTexto := cTexto || cDocto || Substr(cSpace50, 1, 10);           -- 38.3P Identificação do Título na Empresa
      cTexto := cTexto || Substr(aDadosCNAB[19], 1, 01);               -- 39.3P Código para Protesto

      -- Se for para não protestar o numero de dias corridos deve ser zero
      if substr(adadosCNAB[19],1,01) = '3' then
         cTexto := cTexto || '00';
      else
         cTexto := cTexto || Substr(aDadosCNAB[20], 1, 02);            -- 40.3P Número de Dias para Protesto
      end if;

      cTexto := cTexto || Substr(aDadosCNAB[21], 1, 01);               -- 41.3P Código para Baixa/Devolução
      cTexto := cTexto || '0';                                         -- 42.3P Reservado para uso do Banco
      cTexto := cTexto || Substr(aDadosCNAB[22], 2, 02);               -- 43.3P Número de Dias para Baixa/Devolução
      cTexto := cTexto || '00';                                        -- 44.3P Código da Moeda
      cTexto := cTexto || Substr(cSpace50, 1, 11);                     -- 45.3P Reservado para uso do Banco
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RDP',    cTexto,    240 );

      -- Recupera o nome, o tipo de inscrição (CPF ou CNPJ) e a inscrição
      Select sfh_cnpj,  sfi_cpf,   sys_limpa_campo(sfj_nome,False)
        Into cCNPJClie, cCPF_Clie, cNomeClie
        From [(sfm)]
       Where sfj_pessoa = iCliente;
      -- Determina o tipo de inscrição 0=Isento, 1=CPF e 2=CNPJ
      -- Determina o numero do CNPJ ou CPJ com tamanho 15
      cTipoCNPJ := '2';
      cCNPJ_CPF := '0' || cCNPJClie;
      If cCNPJClie Is Null Then
         If cCPF_Clie Is Null Then
            cTipoCNPJ := '0';
            cCNPJ_CPF := Sys_Strzero(0, 15);
         Else
            cTipoCNPJ := '1';
            cCNPJ_CPF := '0000' || cCPF_Clie;
         End If;
      End If;

      -- Recupera o endereço de cobrança do cliente
      rCobranca := mc_00211####???(iCliente);
      If rCobranca.cep Is Null Then
         raise '[[ATENÇÃO. Esta faltando o CEP do Cliente: %-%. Verifique!]]', iCliente, cNomeClie;
      End If;

      -- Registro Detalhe - Segmento Q (Obrigatório Remessa)
      iOrdem := iOrdem + 1;
      iLotes := iLotes + 1;
      cTexto := cCodBanco;                                             -- 01.3Q Código do Banco na Compensação
      cTexto := cTexto || '0001';                                      -- 02.3Q Lote de Serviço
      cTexto := cTexto || '3';                                         -- 03.3Q Tipo de Registro
      cTexto := cTexto || Sys_Strzero(iLotes, 5);                      -- 04.3Q Nº Seqüencial do Registro no Lote
      cTexto := cTexto || 'Q';                                         -- 05.3Q Código de Segmento do Reg. Detalhe
      cTexto := cTexto || ' ';                                         -- 06.3Q Reservado para uso do Banco
      cTexto := cTexto || '01';                                        -- 07.3Q Código de Movimento Remessa
      cTexto := cTexto || cTipoCNPJ;                                   -- 08.3Q Tipo de Inscrição
      cTexto := cTexto || cCNPJ_CPF;                                   -- 09.3Q Número de Inscrição
      cTexto := cTexto || Substr(cNomeClie || cSpace50, 1, 40);        -- 10.3Q Nome do Sacado
      cTexto := cTexto || Substr((rCobranca.endereco || ', ' ||
                                  rCobranca.numero) || cSpace50, 1, 40);  -- 11.3Q Endereço do Sacado - Rua e Número
      cTexto := cTexto || Substr(rCobranca.bairro || cSpace50, 1, 15);    -- 12.3Q Endereço do Sacado - Bairro
      cTexto := cTexto || Substr(rCobranca.cep, 1, 05);                -- 14.3Q Endereço do Sacado - CEP
      cTexto := cTexto || Substr(rCobranca.cep, 6, 03);                -- 15.3Q Endereço do Sacado - Complemento do CEP
      cTexto := cTexto || Substr(rCobranca.cidade || cSpace50, 1, 15);    -- 13.3Q Endereço do Sacado - Nome da Cidade
      cTexto := cTexto || Substr(rCobranca.uf, 1, 02);                 -- 16.3Q Endereço do Sacado - Sigla do Estado
      cTexto := cTexto || '0';                                         -- 17.3Q Tipo de Inscrição - Avalista
      cTexto := cTexto || Sys_Strzero(0, 15);                          -- 18.3Q Número de Inscrição - Avalista
      cTexto := cTexto || Substr(cSpace50, 1, 40);                     -- 19.3Q Nome do Sacador/Avalista
      cTexto := cTexto || '000';                                       -- 20.3Q Identificador de Carne
      cTexto := cTexto || '000';                                       -- 21.3Q Sequencial da Parcela
      cTexto := cTexto || '000';                                       -- 22.3Q Quantidade Total de Parcelas
      cTexto := cTexto || '000';                                       -- 23.3Q Número do Plano
      cTexto := cTexto || Substr(cSpace50, 1, 19);                     -- 22.3Q Reservado para uso do Banco
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RDQ',    cTexto,    240 );

      --Testar se tem Multa e inclui o Bloco R
      if aDadosCnab[25]::numeric > 0 or
         dMultaData is not null then

         iOrdem  := iOrdem  + 1;
         iLotes  := iLotes  + 1;
         iDoctos := iDoctos + 1;

         cTexto := cCodbanco;
         cTexto := cTexto || '0001';
         cTexto := cTexto || '3';
         cTexto := cTexto || Sys_Strzero(iLotes, 5);
         cTexto := cTexto || 'R';
         cTexto := cTexto || ' ';
         cTexto := cTexto || '01';
         cTexto := cTexto || ' ';
         cTexto := cTexto || '        ';
         cTexto := cTexto || Sys_Strzero(0, 15);
         cTexto := cTexto || Substr(cSpace50, 1, 24);
         cTexto := cTexto || '1';
         cTexto := cTexto || to_char(dMultaData,'DDMMYYYY');
         cTexto := cTexto || Sys_StrzeroDec(aDadosCnab[25]::numeric,2,'', 15);
         cTexto := cTexto || Substr(cSpace50, 1, 10);
         cTexto := cTexto || Substr(cSpace50, 1, 40);
         cTexto := cTexto || Substr(cSpace50, 1, 10);
         cTexto := cTexto || Substr(cSpace50, 1, 61);

         Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                     Values  ( cSessao, 'RDR',    cTexto,    240 );
      end if;

      -- Atualiza o título com o número da remessa
      Update [(san)]
         Set fbs_remessa  = iRemessa, ak_cc = cContaBco,
             an_tipo_cobr = (Case When an_tipo_cobr < 1 Then iCarteira Else an_tipo_cobr End)
       Where an_codtit = iTitulo
         And an_parce  = iParcela;

      -- Conta e totaliza os títulos incluídos na remessa
      iDoctos := iDoctos + 1;
      nTotal  := nTotal  + nValor;

      Fetch xSelecao Into iTitulo, iParcela, nValor, dEmissao, dVencto, iCliente, cNumero, iCarteira, sEspecie,
                          nMultaPerc, dMultadata, nMultaValor, iNNumeroDc;
   End Loop;
   Close xSelecao;

   -- Inclui o registro TRAILER do lote
   iOrdem := iOrdem + 1;
   iLotes := iLotes + 2;
   cTexto := cCodBanco;                                             -- 01.5 Código do Banco na Compensação
   cTexto := cTexto || '0001';                                      -- 02.5 Lote de Serviço
   cTexto := cTexto || '5';                                         -- 03.5 Tipo de Registro
   cTexto := cTexto || Substr(cSpace50, 1, 09);                     -- 04.5 Reservado para uso do Banco
   cTexto := cTexto || Sys_Strzero(iLotes, 06);                     -- 05.5 Quantidade de Registros do Lote
   cTexto := cTexto || cSpace50 || cSpace50 || cSpace50;            -- 09.5 Reservado para uso do Banco
   cTexto := cTexto || cSpace50 || Substr(cSpace50, 1, 17);         -- 09.5 Reservado para uso do Banco
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RTL',    cTexto,    240 );

   -- Inclui o registro TRAILER do arquivo de remessa
   iOrdem := iOrdem + 1;
   cTexto := cCodBanco;                                             -- 01.9 Código do Banco na Compensação
   cTexto := cTexto || '9999';                                      -- 02.9 Lote de Serviço
   cTexto := cTexto || '9';                                         -- 03.9 Tipo de Registro
   cTexto := cTexto || Substr(cSpace50, 1, 09);                     -- 04.9 Reservado para uso do Banco
   cTexto := cTexto || Sys_Strzero(01, 06);                         -- 05.9 Quantidade de Registros Tipo 1 do Arquivo
   cTexto := cTexto || Sys_Strzero(iOrdem, 06);                     -- 06.9 Quantidade de Registros do Arquivo
   cTexto := cTexto || cSpace50 || cSpace50 || cSpace50;            -- 07.9 Reservado para uso do Banco
   cTexto := cTexto || cSpace50 || Substr(cSpace50, 1, 11);         -- 07.9 Reservado para uso do Banco
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RTA',    cTexto,    240 );

   -- Atualiza os registros selecionados com o número da remessa
   Update [(fr3)]
      Set fbs_remessa = iRemessa
    Where fr3_selecao = 1
      And fbs_remessa Is Null;

   -- Atualiza o registro na tabela de arquivos de remessa - FBS
   Update [(fbs)]
      Set fbs_doctos = iDoctos, fbs_total = nTotal
    Where ak_cc = cContaBco
      And fbs_remessa = iRemessa;

   out_res := 1;
End;
$$ language 'plpgsql';
