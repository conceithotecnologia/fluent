/**
   Trigger da Tabela CT2 - Niveis do Plano de Contas

	@author    Fabio Carvalho
	@date      11/03/2011
	@trigger   CT2 B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   12/03/2011 18:26:18  v2 Ricardo Gonçalves.
      [+] Atualização do campo que contém a lagura da conta do nível

*/
Create or Replace Function mc_00400####???()
Returns trigger
As $$
Declare
-- {Variáveis de uso interno}
   iNiveis   integer;       --[(ct1)].ct1_niveis%type;

Begin
   if tg_op = 'DELETE' then
      if mc_getflagc####???('CT1', old.ct1_recno) <> 1 then
         raise '[[Níveis do plano de contas só podem ser excluídos por rotinas de sistema!]]';
      end if;

      return old;
   else
      if tg_op = 'INSERT' then
         if mc_getflagc####???('CT1', new.ct1_recno) <> 1 then
            raise '[[Níveis do plano de contas só podem ser criados por rotinas de sistema!]]';
         end if;
      end if;

      -- Seleciona Quantidade de Niveis Permitidos
      select ct1_niveis
        into iNiveis
        from [(ct1)]
       where recno = new.ct1_recno;

      if new.ct2_nivel > iNiveis then
         raise '[[ATENÇÃO. É permitido somente % níveis. Verifique!]]', iNiveis;
      end if;

      select sum(ct2_tamanho)
        into new.ct2_larg
        from [(ct2)]
       where ct1_recno = new.ct1_recno
         and ct2_nivel < new.ct2_nivel;

      -- Define a largura da conta
      new.ct2_larg := coalesce(new.ct2_larg, 0) + new.ct2_tamanho;

      return new;
   end if;

End;
$$ language plpgsql;