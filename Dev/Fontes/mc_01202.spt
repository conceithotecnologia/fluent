/**
   Trigger - Before  NG7 - Notas Fiscais Entrada Portaria

	@author    Fabio Carvalho
	@date      24/01/2019
	@trigger   NG7 B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

*/
Create or Replace Function mc_01202####???()
Returns trigger AS $$
Declare
Begin

   if tg_op <> 'DELETE' then
      --Verifica se Nota Foi Incluida na Manifestacao
      if not exists(select 1 from [(ng5)] where ng5_chnfe = new.ng7_chnfe) then
         raise '[[ATENÇÃO. Nota não localizada na Manifestação do Destinatário. Verifique!]]';
      end if;

      --Verifica se Nota Esta como confirmada na manifestação
      if not exists(select 1 from [(ng5)] where ng5_chnfe = new.ng7_chnfe and ng5_csitconf = 1) then
         raise '[[ATENÇÃO. A Nota foi localizada na Manifestação do Destinatário, porem a situação não foi Confirmada. Verifique!]]';
      end if;
   elsif tg_op = 'DELETE' then
      return old;
   end if;

   Return new;
End;
$$ language plpgsql;