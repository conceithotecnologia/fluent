/**
   Checa o login informado em relação ao contexto

	@author    Ricardo Gonçalves
	@date      14/07/2009 21:20:35
	@trigger

	@param  in_user  usuário
	@param  in_pass  senha

	@return retorna 1 caso o usuário seja válido

	Tabela se erros
   ---------------------------------------------------------------------------------------------------------------------
   Código | Descrição
   ---------------------------------------------------------------------------------------------------------------------
     0000   Usuário Inválido
     0002   Usuário informado é nulo (parâmetro in_user)
     0003   Senha informada é nula (parâmetro in_pass)
     0006   Grupos não pode logar-se no sistema
     0007   Senha informada inválida
     0008   Usuário inativo
     0010   Senha do usuário expirou

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   31/10/2012 13:39:00  v2    Ricardo.
      [-] Teste para verificar se a senha está expirada estava errado.
*/
Create or Replace Function sys_login_session####???(
   in in_user varchar,
   in in_pass varchar)
Returns integer
AS
$$
Declare
   r03         record;
Begin

   if in_user is null then
      return 2;
   end if;

   if in_pass is null then
      return 3;
   end if;

   -- recupera usuário e papel
   select a.active, a.type_, a.password, a.passexpire_enable, a.passexpire
     into r03
     from [(ss003)] a
    where a.coduser = in_user;

   if not found then
      return 0;
   end if;

   -- Checa se o usuário está ativo
   if r03.active <> 1 then
      return 8;
   end if;

   -- Checa se trata-se de Usuário ou Grupo
   if r03.type_ = 2 then
      return 6;
   end if;

   -- Checa a senha
   if r03.password <> in_pass then
      return 7;
   end if;

   -- Checa se a senha expirou
   if r03.passexpire_enable = 1 and r03.passexpire < current_date then
      return 10;
   end if;

   return 1;
End;
$$
language plpgsql;