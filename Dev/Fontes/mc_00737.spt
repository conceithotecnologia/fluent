/**
   Geração do nome do arquivo de remessa da cobrança bancária CNAB

	@author    Jurandy da Silva Costa
	@date      03/12/2009 19:30:00
	@trigger

        @return cNomeArq -> Nome do arquivo de retorno a ser gerado

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   03/12/2009 19:30:00  v1.0  Jurandy da Silva Costa.
      [*] Sem histórico.

   05/11/2010 20:00:00  v1.1  Jurandy da Silva Costa.
      [*] Acrescentado layout CNAB 400 do banco BRADESCO.
*/
Create or Replace Function mc_00737####???( Out cNomeArq  Varchar )
As $$
Declare

-- {Variáveis de uso interno}
   iRemessa       [(fbs)].fbs_remessa%type;       -- Número da remessa
   cContaBco      [(fr3)].ak_cc%type;             -- Número da conta
   cSessao        [(fr3)].session%type;           -- Sessão atual do usuário
   cDiretorio     [(sak)].ak_pasta_rem%type;      -- Diretório para geração da remessa
   iCodBanco      [(sak)].a9_codbanco%type;       -- Código do banco a gerar remessa
   iFebraban      [(sa9)].r_febraban%type;        -- Gerar no padrão FEBRABAN 0=Não, 1=Sim
   vCedente       [(sak)].ak_cedente%type;        -- Codigo do cedente
   cNrOrdem       VarChar(2);
   iQuantos       integer;
Begin
   -- Recupera o número da conta que está sendo processada na sessão atual
   Select Max(ak_cc) Into cContaBco
     From [(fr3)]
    Where session = sys_session();

   -- Recupera o último número de remessa do usuário atual
   Select Max(fbs_remessa)
     Into iRemessa
     From [(fbs)]
    Where ak_cc = cContaBco
      And fbs_user_g = sys_user####???();

   -- Recupera o diretório indicado no cadastro da conta bancária
   Select ak_pasta_rem, a9_codbanco, ak_cedente
     Into cDiretorio,   iCodBanco,   vCedente
     From [(sak)]
    Where ak_cc = cContaBco;

   -- Recupera o indicador de padrão FEBRABAN no banco
   Select r_febraban
     Into iFebraban
     From [(sa9)]
    Where a9_codbanco = iCodBanco;

   -- Monta o nome do arquivo de remessa
   cNomeArq := Coalesce(cDiretorio, '') || 'REM' || Sys_Strzero(iRemessa, 5) || '.REM';
   If iFebraban = 0 And iCodBanco = 237 Then
      cNrOrdem := Sys_Strzero((Select Count(*) From [(fbs)]
                                              Where ak_cc = cContaBco And fbs_status = 1
                                                And fbs_data_g::DATE = CURRENT_TIMESTAMP::DATE), 2);
      cNomeArq := Coalesce(cDiretorio, '') || 'CB' || Sys_Strzero(Sys_Day(CURRENT_TIMESTAMP::DATE), 2) ||
                  Sys_Strzero(Sys_Month(CURRENT_TIMESTAMP::DATE), 2) || cNrOrdem || '.REM';

   --Sicredi
   elsif iCodBanco = 748 then
      cNomeArq := Coalesce(cDiretorio,'') ||
                  rpad(vCedente,5)        ||
                  substring('123456789OND', to_char(current_date,'MM')::integer,1) ||
                  to_char(current_date,'DD');

      --Verifica se ainda não foi gerado nesta data
      if not exists(select 1
                      from [(fbs)]
                     where ak_cc = cContaBco
                       and fbs_data_g::date = current_date) then
         cNomeArq := cNomeArq || '.CRM';
      else
         select count(*)
           into iQuantos
           from [(fbs)]
          where ak_cc = cContaBco
            and fbs_data_g::date = current_date;

         if iQuantos > 10 then
            raise '[[ATENÇÃO. Excedeu o numero de remessas diaria para o Banco Sicredi. Verifique]]';
         else
            cNomeArq := cNomeArq || '.RM' || substring('1234567890',iQuantos + 1,1);
         end if;
      end if;
   End If;

   -- Grava o nome do arquivo na tabela de remessas - FBS
   Update [(fbs)]
      Set fbs_arquivo = cNomeArq
    Where ak_cc = cContaBco
      And fbs_remessa = iRemessa;

End;
$$ language 'plpgsql';
