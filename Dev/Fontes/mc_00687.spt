/**
   Rotina de Validacao dos Itens Marcados Para Emissao de Cheques

	@author    Fabio Crepaldi Carvalho
	@date      10/11/2006 20:30:00
	@trigger

	@param in_iRecno Número do recno selecionado pelo usuário na tabela
   @param in_iSelecao 0-Removida a Seleção, 1-Registro Selecionado ou -1=Finalização do formulário 

   @return 1 - Sucesso / 0 - Falha

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   02/02/2015 14:30:00  v1   Wagner Mobile Costa
      [*] Tratamento para marcação de registros sempre baseado em recno ou na ação de finalização do formulário
*/
Create or Replace Function mc_00687####???
( In  in_irecno   Integer,
      in_iselecao Integer,
  Out out_res     Integer )
As $$
Declare

-- {Variáveis para cursores}

-- {Variáveis de uso interno}
   nQuantos       Integer;
   Conta1         [(sak)].ak_cc%type;
   Conta2         [(sak)].ak_cc%type;
   cSessao        [(ss027)].session%type;    -- Sessao atual do usuário

Begin
   Out_res := 1;

   -- Recupera a Sessão atual
   if in_iselecao = 1 then
      cSessao := sys_session();

      -- Verifica Quantos Itens Estao Marcados
      Select count(*), Max(fsd.ak_cc), Min(fsd.ak_cc)
        Into nQuantos, Conta1,         Conta2
        From [(ss029)] ss029
        Join [(fsd)]   fsd
          On ss029.recfile = fsd.recno
       Where session = sys_session();

      if nQuantos < 2 or nQuantos is Null Then
         Out_Res := 1;
      End If;

      If Conta1 <> Conta2 Then
         raise '[[Voce selecionou mais de uma Conta !.]]';
         Out_res := 0;
      End If;

      -- Insere registro Flag do detalhamento por Natureza Financeira
      Perform mc_setflag####???( 'FSD', 1);
   end if;  

End;
$$ language 'plpgsql';