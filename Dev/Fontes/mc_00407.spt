/**
   Trigger da Tabela CTC - Niveis do Plano de Contas

	@author    Fabio Carvalho
	@date      01/04/2011
	@trigger   CT2 B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   12/03/2011 18:26:18  v2 Ricardo Gonçalves.
      [+] Atualização do campo que contém a lagura da conta do nível

*/
Create or Replace Function mc_00407####???()
Returns trigger
As $$
Declare
-- {Variáveis de uso interno}
   iNiveis   [(ctb)].ctb_niveis%type;

Begin
   if tg_op = 'DELETE' then
      if mc_getflag####???('CTB', old.ctb_recno) <> 1 then
         raise '[[Níveis do plano de contas só podem ser excluídos por rotinas de sistema!]]';
      end if;

      return old;
   else
      if tg_op = 'INSERT' then
         if mc_getflag####???('CTB', new.ctb_recno) <> 1 then
            raise '[[Níveis do plano de contas só podem ser criados por rotinas de sistema!]]';
         end if;
      end if;

      -- Seleciona Quantidade de Niveis Permitidos
      select ctb_niveis
        into iNiveis
        from [(ctb)]
       where recno = new.ctb_recno;

      if new.ctc_nivel > iNiveis then
         raise '[[ATENÇÃO. É permitido somente % níveis. Verifique!]]', iNiveis;
      end if;

      select sum(ctc_tamanho)
        into new.ctc_larg
        from [(ctc)]
       where ctb_recno = new.ctb_recno
         and ctc_nivel < new.ctc_nivel;

      -- Define a largura da conta
      new.ctc_larg := coalesce(new.ctc_larg, 0) + new.ctc_tamanho;

      return new;
   end if;

End;
$$ language plpgsql;