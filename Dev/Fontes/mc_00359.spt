/**
   Executa rotinas de cálcula associadas ao ensaio

	@author    Ricardo Gonçalves
	@date      07/05/2011 15:12:46
	@trigger   B39 A IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   17/05/2011 18:06:50  v2    Ricardo Gonçalves.
      [+] Inserção dos parâmetros caso exista cálculos para o ensaio
   
   03/09/2012 19:51:00  v3    Ricardo Gonçalves.
      [+] Ignora processamento e checagem quando o resultado tratar-se de histórico
  
   16/07/2013 16:41:00  v4    Ricardo Gonçalves.
      [-] Sistema atualizado para realizar todos os cálculos em laudos históricos também.
*/
CREATE OR REPLACE FUNCTION mc_00359####???()
  RETURNS trigger AS
$$
BEGIN
   if tg_op <> 'DELETE' then
      if new.b00_proc is not null then
         if tg_op = 'UPDATE' then
            if mc_getflag####???('B39', new.recno) = 0 then
               -- Marca registro
               perform mc_setflag####???('B39', new.recno);

               -- Executa cálculo
               execute 'select ' || sys_rotina####???(new.b00_proc) || '('||new.recno||')';
               -- Exclui marcador
               perform mc_delflag####???('B39', new.recno);
            end if;
         else
            -- Cria parâmetros na tabela de itens
            INSERT INTO [(b40)](
               b07_recno, b03_recno, b36_recno, b00_proc, b04_param)
            select new.b07_recno, new.b03_recno, new.b36_recno,
                   new.b00_proc, b04_param
              from [(b04)]
             where b00_proc = new.b00_proc;
         end if;
      end if;

      return new;
   else
      return old;
   end if;
END;
$$
  LANGUAGE 'plpgsql' VOLATILE;