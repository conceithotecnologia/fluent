/**
   Trigger da Tabela LC0 - Locação Caçamba

	@author    Fabio Carvalho
	@date      14/02/2012
   @trigger   LC0 B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   12/03/2011 18:26:18  v2 Ricardo Gonçalves.
      [+] Atualização do campo que contém a lagura da conta do nível

*/
Create or Replace Function mc_00397####???()
Returns trigger
As $$
Declare
-- {Variáveis de uso interno}
Begin
   if tg_op = 'DELETE' then

      if old.lc0_desc_numero > 0 then
         raise '[[ATENÇÃO. Não é possivel excluir Locação com descarte. Verifique !]]';
      end if;

      return old;
   end if;

   if tg_op = 'UPDATE' then
      -- verifica mudanca de Status
      if old.lc0_status = 0 and new.lc0_status = 2 and new.lc0_desc_numero > 0 then
         raise '[[Não é possivel cancelar Locação descartada. Verifique!]]';

      elsif old.lc0_status = 2 then
         raise '[[Não é possivel alteração em Locação Cancelada. Verifique!]]';

      elsif coalesce(old.lc0_desc_numero,0) <> coalesce(new.lc0_desc_numero,0) then
         new.lc0_status := 1;
      end if;
   end if;
   
   return new;
End;
$$ language plpgsql;