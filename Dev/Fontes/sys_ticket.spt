/**
   Retorna o ticket

	@author    Ricardo Gonçalves
	@date      01/02/2017
	@trigger

	@param  in_session sessão na qual será vinculada o ticket

	@return retorna o ticket criado

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
*/
Create or Replace Function sys_ticket####???(
   in in_session varchar(35))
Returns varchar(41)
AS
$$
Declare   
   vticket     [(ss027)].ticket%type;   
Begin   
   if in_session is null then
      raise '[[Sessão "%" é inválida ou está nula!]]', in_session;
   end if;
   
   vticket := to_char(clock_timestamp(), 'HH24MI') || md5(to_char(clock_timestamp(), 'DDMMYYYYHH24MISSMSUS')) ||
      to_char(clock_timestamp(), 'MSSS');
   
   -- Muda a sessão corrente
   execute 'set session authorization ' || quote_literal(in_session);
   
   update [(ss027)]
      set ticket = vticket   
   where session = in_session;
   
   if not FOUND then
      raise '[[Não foi possível associar o ticket % a sessão %.]]', in_session, vticket;
   end if;

   return vticket;
End;
$$
language plpgsql;