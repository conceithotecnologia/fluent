/*==================================================================================================================================
| Empresa..: MultCont Informática                                                                                                  |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Autor....: Wagner Mobile Costa                                                                                                   |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Data.....: 21/12/2004 21:40:00                                       Alterado.: 05/02/2011                                       |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Tipo.....: Stored Procedure                                                                                                      |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Descrição: Muda a condição de edição dos campos 'AK_CC,FA1_CAIXA,FAN_DOCTO,FAN_MULTA,FAN_JUROS' da tabela FAN                    |
| -------------------------------------------------------------------------------------------------------------------------------- |
==================================================================================================================================*/
create or replace function mc_whenfan####???( out out_res Integer) As $$
Declare
   iFan_motivo Integer; -- Motivo da Baixa;
   iEnabled    integer;
   iTitulo     Integer;
   iParcela    Integer;
   iRemessa    Integer;
   iCaixa      Integer;
   iRecno      Integer;
   dPagto      Date;
   dPrevi      Date;
   cConta      Varchar(25);
   nRetidos    Numeric(15, 2);
   nRetPago    Numeric(15, 2);
   nPagou      Numeric(15, 2);
   nDesco      Numeric(15, 2);
   nMulta      Numeric(15, 2);
   nJuros      Numeric(15, 2);

begin
   out_res := 0;

   -- Busca o motivo da baixa no arquivo de sessão
   iFan_motivo := sys_042integer####???('fan_motivo');

   -- Somente habilita os campos se for motivo de baixa por pagamento
   iEnabled := 0;
   if iFan_motivo in (1,5) then
      iEnabled := 1;
   end if;

   -- Atualiza o arquivo de sessão habilitando ou desabilitando campos
   update [(ss042)]
      set enabled = iEnabled
    where session = sys_session()
      and Columnname in ('ak_cc','fa1_caixa','fan_docto','fan_multa','fan_juros');

   -- Busca o conteúdo atual do campo Código do Caixa
   iCaixa := sys_042integer####???('fa1_caixa');
   -- Busca o conteúdo atual do campo Conta Bancária
   cConta := sys_042string####???('ak_cc');
   -- Busca o conteúdo atual do campo Valor Liquído Pago
   nPagou := sys_042number####???('fan_valor');
   -- Busca o conteúdo atual do campo Valor do Desconto
   nDesco := sys_042number####???('fan_desconto');
   -- Busca o conteúdo atual do campo Valor da Multa
   nMulta := sys_042number####???('fan_multa');
   -- Busca o conteúdo atual do campo Valor dos Juros
   nJuros := sys_042number####???('fan_juros');
   -- Busca o conteúdo atual do campo Data do Pagamento
   dPagto := sys_042date####???('fan_data');
   -- Busca o conteúdo atual do campo Data do Crédito
   dPrevi := sys_042date####???('fan_dtprevi');

   -- Caso a baixa ainda não tenha sido inicializada
   If iCaixa Is Null and cConta Is Null And (nPagou + nDesco + nMulta + nJuros) = 0 Then
      -- Busca o número de registro no cabeçalho do Título
      Select integer_
        Into iRecno
        From [(ss042)]
       Where session = sys_session()
         And codtable = 'SAN'
         And columnname = 'recno';

      -- Busca Conta Bancária e valor da baixa no cabeçalho do Título
      Select ak_cc,  an_saldo, an_codtit, an_parce, fbs_remessa
        Into cConta, nPagou,   iTitulo,   iParcela, iRemessa
        From [(san)]
       Where recno = iRecno;

      -- Busca o número de registro no cabeçalho do Título
      Select integer_ Into iRecno
        From [(ss042)]
       Where session = sys_session()
         And codtable = 'SAN'
         And columnname = 'recno';

      -- Busca a soma das retenções no detalhamento
      Select Sum(fbf_retido) Into nRetidos
        From [(fbf)]
       Where an_codtit = iTitulo
         And an_parce  = iParcela;

      -- Busca a soma das retenções rateadas nos valores recebidos
      Select Sum(fan_retidos) Into nRetPago
        From [(fan)]
       Where an_codtit = iTitulo
         And an_parce  = iParcela;
      If nRetPago > 0.00 And nRetidos > nRetPago Then
         nRetidos := nRetidos - nRetPago;
      End If;

      -- Atualiza a tabela de sessão com a Conta Bancária, Valor da Baixa e Total da Retenção
      Update [(ss042)]
         Set string_ = cConta
       Where session = sys_session()
         And Columnname = 'ak_cc';
      Update [(ss042)]
         Set number_ = nPagou
       Where session = sys_session()
         And Columnname = 'fan_valor';
      Update [(ss042)]
         Set number_ = nRetidos
       Where session = sys_session()
         And Columnname = 'fan_retidos';

      -- Sugere o número do Titulo e Parcela nas observações da baixa
      Update [(ss042)]
         Set string_ = 'Titulo' || TO_CHAR(iTitulo, '000000')  ||
                       ' - Parcela' || TO_CHAR(iParcela, '00')
       Where session = sys_session()
         And Columnname = 'fan_observa';

      -- Desabilita o número da conta bancária se o título fez parte de uma remessa CNAB
--      Update [(ss042)]
--         Set enabled = (Case When iRemessa Is Null Then 1 Else 0 End)
--       Where session = sys_session()
--         And Columnname In ('ak_cc', 'fa1_caixa');
   else
      -- Busca o número de registro no cabeçalho do Título
      Select integer_
        Into iRecno
        From [(ss042)]
       Where session = sys_session()
         And codtable = 'SAN'
         And columnname = 'recno';

      -- Busca Conta Bancária e valor da baixa no cabeçalho do Título
      Select an_codtit, an_parce
        Into iTitulo,   iParcela
        From [(san)]
       Where recno = iRecno;
       
      -- Sugere o número do Titulo e Parcela nas observações da baixa
      Update [(ss042)]
         Set string_ = 'Titulo' || TO_CHAR(iTitulo, '000000')  ||
                       ' - Parcela' || TO_CHAR(iParcela, '00') ||
                       case when iFan_motivo = 5 then ' - Devolução' else '' end
       Where session = sys_session()
         And Columnname = 'fan_observa';
   End If;
   -- Se a baixa for para banco buscar D+ para calcular a data da compensação
   If cConta Is Not Null And dPrevi Is Null Then
      dPrevi := dPagto + (Select Coalesce(ak_diasret, 0) From [(sak)] Where ak_cc = cConta);
      Update [(ss042)]
         Set date_ = dPrevi
       Where session = sys_session()
         And Columnname = 'fan_dtprevi';
   End If;
   -- Se a baixa for por pagamento habilita apenas Conta Bancária ou Código do Caixa
   If iEnabled = 1 Then
      If iCaixa Is Null And cConta Is Not Null Then
         -- Atualiza o arquivo de sessão desabilitando o campo Código do Caixa
         Update [(ss042)]
            Set enabled = 0
          Where session = sys_session()
            And Columnname = 'fa1_caixa';
      End If;
      If cConta Is Null And iCaixa Is Not Null Then
         -- Atualiza o arquivo de sessão desabilitando o campo Conta Bancária
--         Update [(ss042)]
--            Set enabled = 0
--          Where session = sys_session()
--            And Columnname = 'ak_cc';
      End If;
   End If;
   out_res:= 1;
end;
$$ language plpgsql;
