/**
   Trigger de Tela da tabela ctr - Lançamentos Contabeis - Partida Dobrada

	@author    Fabio Carvalho
	@date      15/07/2011
	@trigger

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

*/
Create or Replace Function scr_00084_ctr####???
(  out out_res integer )
As $$
Declare
   iPlano     [(ctb)].recno%type;
   iReduzida  [(ctb)].ctb_reduzida%type;
   iHistorico [(ct8)].recno%type;
   iConta     [(cte)].ctd_conta%type;
   iContaRed  [(cte)].ctd_reduzida%type;
   iCPart     [(cte)].cte_cpart%type;
   iCPartRed  [(cte)].cte_cpart_reduz%type;
   bInclusao  boolean;
   iPadrao    [(cte)].ct8_recno%type;
   rRec       Record;
Begin

   -- recupera plano padrão
   iPlano   := sys_042integer2####???('CTR', 'ctb_recno');
   if iPlano is null then
      select recno
        into iPlano
        from [(ctb)]
       where ctb_status   = 1
         and sys_getdatabase####???() between ctb_inicio and ctb_termino;
      if not found then
         raise '[[ATENÇÃO. Não há plano de contas em uso por esta empresa. Verifique !]]';
      end if;
      perform sys_042integer_wr####???('CTR', 'ctb_recno', iPlano);
   end if;

   -- testa se inclusao
   bInclusao := False;
   if sys_042integer2####???('CTR', 'recno') is null then
      bInclusao := True;
   end if;

   -- verifica se empresa faz digitação por numero simplificado ou nao
   select coalesce(ctb_reduzida,0)
     into iReduzida
     from [(ctb)]
    where recno   = iPlano;

   -- Se há Lancamento Padrao
   iPadrao := sys_042integer2####???('CTR', 'ctj_recno');
   if iPadrao is not null then
--    select b.ctd_reduzida   as deb_red,
--           a.ctd_conta_deb  as deb_cta,
--           c.ctd_reduzida   as cre_red,
--           a.ctd_conta_cred as cre_cta,
--           a.ct8_recno      as cod_his
--      from [(ctj)] a
--      join [(ctd)] b on  b.ctb_recno = a.ctb_recno and
--                         b.ctd_conta = a.ctd_conta_deb
--      join [(ctd)] c on  c.ctb_recno = a.ctb_recno and
--                         c.ctd_conta = a.ctd_conta_cred
--      into rRec
--     Where a.recno = iPadrao;
--
--    -- atualiza conta devedora cheia
--    update [(ss042)] set string_ = rRec.deb_cta
--     where codtable   = 'CTR'       and
--           columnname = 'ctd_conta' and
--           session    = sys_session();
--
--    -- atualiza conta credora cheia
--    update [(ss042)] set string_ = rRec.cre_cta
--     where codtable   = 'CTR'       and
--           columnname = 'cte_cpart' and
--           session    = sys_session();
--
--    -- atualiza conta devedora simplificada
--    update [(ss042)] set string_ = rRec.deb_red
--     where codtable   = 'CTR'       and
--           columnname = 'ctd_reduzida' and
--           session    = sys_session();
--
--    -- atualiza conta credora simplificada
--    update [(ss042)] set string_ = rRec.cre_red
--     where codtable   = 'CTR'       and
--           columnname = 'cte_cpart_reduz' and
--           session    = sys_session();
--
--    -- Atualiza HP
--    update [(ss042)] set integer_ = rRec.cod_his
--     where codtable   = 'CTR'       and
--           columnname = 'ct8_recno' and
--           session    = sys_session();

--    -- Desabilita digitação dos campos que vieram do lançamento padrao
--    update [(ss042)] set enabled = 2
--     where codtable = 'CTR' and
--           session  = sys_session() and
--           columnname in ('ctd_conta', 'cte_cpart', 'ctd_reduzida', 'cte_cpart_reduz', 'ct8_recno');
   end if;

-- iConta    := sys_042string2####???('CTR', 'ctd_conta');
-- iContaRed := sys_042string2####???('CTR', 'ctd_reduzida');
-- iCPart    := sys_042string2####???('CTR', 'cte_cpart');
-- iCPartRed := sys_042string2####???('CTR', 'cte_cpart_reduz');



/*
   -- habilita / desabilita campos de acordo com a digitação do numero simplificado
   if iReduzida = 0 then --0=nao 1=sim

      -- desabilita conta reduzida
      update [(ss042)] set enabled = 2, visible = 0
       where codtable   = 'CTR'          and
             columnname = 'ctd_reduzida' and
             session    = sys_session();

      -- desabilita contra partida reduzida
      update [(ss042)] set enabled = 2, visible = 0
       where codtable   = 'CTR'             and
             columnname = 'cte_cpart_reduz' and
             session    = sys_session();

      -- habilita conta normal
      perform sys_042enabled_wr####???('CTR', 'ctd_conta', 1);

      -- habilita contrapartida normal
      perform sys_042enabled_wr####???('CTR', 'cte_cpart', 1);

      -- habilita a Conta Simplificada de Acordo com a Conta
      if iConta is not null then
         perform sys_042string_wr####???('CTR', 'ctd_reduzida', (select ctd_reduzida
                                                                   from [(ctd)]
                                                                  where ctb_recno = iPlano
                                                                    and ctd_conta = iConta));
      end if;

      -- habilita a ContaPartida de Acordo com a Conta
      if iCPart is not null then
         perform sys_042string_wr####???('CTR', 'cte_cpart_reduz', (select ctd_reduzida
                                                                      from [(ctd)]
                                                                     where ctb_recno = iPlano
                                                                       and ctd_conta = iCPart));
      end if;

   else
      -- habilita conta reduzida
      perform sys_042enabled_wr####???('CTR', 'ctd_reduzida', 1);

      -- habilita contra partida reduzida
      perform sys_042enabled_wr####???('CTR', 'cte_cpart_reduz', 1);
      -- desabilita conta normal
      update [(ss042)] set enabled = 2, visible = 0 where codtable = 'CTR' and columnname = 'ctd_conta' and session = sys_session();
      -- desabilita contrapartida normal
      update [(ss042)] set enabled = 2, visible = 0 where codtable = 'CTR' and columnname = 'cte_cpart' and session = sys_session();

      -- habilita a Conta de Acordo com a Conta Simplificada
      if iContaRed is not null then
         perform sys_042string_wr####???('CTR', 'ctd_conta', (select ctd_conta
                                                                from [(ctd)]
                                                               where ctb_recno = iPlano
                                                                 and ctd_reduzida = iContaRed));
      end if;

      -- habilita a ContaPartida de Acordo com a Conta Simplificada
      if iCPartRed is not null then
         perform sys_042string_wr####???('CTR', 'cte_cpart', (select ctd_conta
                                                                from [(ctd)]
                                                               where ctb_recno = iPlano
                                                                 and ctd_reduzida = iCPartRed));
      end if;
   end if;
*/
   -- se inclusao propoe o historico no complemento
   iHistorico := sys_042integer2####???('CTR', 'ct8_recno');

   if sys_042text####???   ('cte_compl') is null and
      iHistorico is not null then
      perform sys_042text_wr####???('CTR', 'cte_compl', (select ct8_descri || ' '
                                                           from [(ct8)]
                                                          where recno = iHistorico));
   end if;

   out_res := 1;
End;
$$ language plpgsql;