/**
   Trigger da Tabela CTY - Lançamentos de movimentos Contabeis (Pai)

	@author    Fabio Carvalho
	@date      28/03/2016 10:58:35
	@trigger   CTY B IUD

	@param

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

*/
Create or Replace Function mc_00937####???()
Returns trigger
As $$
Declare
-- {Variáveis de uso interno}
   iNiveis    [(ctb)].ctb_niveis%type;
   iReduzida  [(ctb)].ctb_reduzida%type;
   rPlano     Record;
Begin

   if tg_op = 'DELETE' then

      -- verifica se vem de outra rotina de lançamento
      if old.codtable <> 'CTY' and 
         mc_getflag####???('D01', old.recno_origem) <> 1 then
         raise '[[Atenção. Não é permitido excluir registro gerado atraves de outra rotina. Verifique ! <MC_00937>]]';
      end if;

      return old;
   else
      --verifica se Já encerrado e não permite alteração
      if tg_op = 'UPDATE' and
         old.cty_status = 1 and new.cty_status = 1 then
         raise '[[ATENÇÃO. Registro com Status de Encerrado. Não é Possivel Alteração. Verifique!]]';
      end if;

      -- verificar se lancamento anterior a data de conciliacao
      select ctb_inicio, ctb_termino
        into rPlano
        from [(ctb)]
       where recno = mc_00939####???(new.cty_data);

      if new.cty_data < rPlano.ctb_inicio  or
         new.cty_data > rPlano.ctb_termino then
         raise '[[Atenção. O plano selecionado permite somente lançamentos no periodo de % a %. Verifique !]]',
               mask_00004(rPlano.ctb_inicio),
               mask_00004(rPlano.ctb_termino);
      end if;

      --Verifica mudança de Status e se há diferença
      if tg_op = 'UPDATE' and old.cty_status = 0 and new.cty_status = 1 then
         if abs(new.cty_diferenca) <> 0 then
            raise '[[ATENÇÃO. Não é possivel encerrar o lançamento pois há diferença entre débito e crédito. verifique!]]';
         elsif abs(new.cty_debito) = 0 and abs(new.cty_credito) = 0 then
            raise '[[ATENÇÃO. Não há lançamentos neste movimento. Verifique!]]';
         end if;
      end if;

 --   --Atualiza Debitos e Creditos
 --   select coalesce(sum(cte_debito),0), coalesce(sum(cte_credito),0)
 --     into new.cty_debito,              new.cty_credito
--      from [(cte)]
--     where cty_recno = new.recno;
    new.cty_diferenca := abs(new.cty_debito - new.cty_credito);

--raise '[[937-passou]]';
      return new;
   end if;
End;
$$ language plpgsql;
