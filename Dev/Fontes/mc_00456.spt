/**
   Geração do arquivo de remessa de pagamentos CNAB - 001-Banco do Brasil - 240

	@author    Fabio Carvalho
	@date      29/08/2012
	@trigger

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
*/
Create or Replace Function mc_00456####???
( in  pConta     Varchar,
  in  pData_Pgto date,
  out out_res    Integer )
As $$

Declare
   iRemessa       [(frq)].frq_remessa%type;       -- Número da remessa
   iTipoPgto      [(sao)].sao_tipo_pgto%type;

   xBanco         Record;
   xDados         record;

   cTexto         Varchar;
   cSessao        varchar;
   sTipo          varchar;

   lHeaderlote    boolean;
   nValorLote     numeric;
   nTtArquivo     numeric;

   iTitulos       integer;
   iItem          integer;
   iLotes         integer;
   iRegistros     integer;
   isequencial    integer;
   iRegLote       integer;
Begin
   -- Inicializa variáveis
   out_res    := 0;
   iLotes     := 0;
   iRegistros := 0;
   nTtArquivo := 0;
   iTitulos   := 0;

   -- recupera a sessao do usuario
   cSessao  := sys_session();

   -- Seleciona Dados Bancarios de acordo com a Tabela Temporaria
   Select sak.a9_codbanco, sak.a0_codag, sak.ak_conta,  sak.ak_digito, sak.ak_digito_ac, sak.sak_cp_dir_rem,
          sa9.p_febraban,  sa9.a9_nome,  sa0.a0_digito, ss027.codemp,  ss063.filial,     ss063.razao,
          ss063.cnpj,      ss063.cpf,    sak.ak_cc,
          coalesce(sa9.a9_nome,'')  as nome,
          coalesce(sys_limpa_campo(ss063.ender,False),'')  as ender,
          coalesce(ss063.num,'')    as num,
          coalesce(ss063.compl,'')  as compl,
          coalesce(sys_limpa_campo(ss063.cidade,False),'') as cidade,
          coalesce(ss063.cep,'')    as cep,
          coalesce(ss063.uf,'')     as uf,
          coalesce(sak.sak_cp_convenio,'') as convenio
     Into xBanco
     From [(sak)] sak
          join [(sa9)]   sa9   on sa9.a9_codbanco = sak.a9_codbanco
          join [(sa0)]   sa0   on sa0.a9_codbanco = sak.a9_codbanco and sa0.a0_codag = sak.a0_codag
          join [(ss027)] ss027 on ss027.session   = cSessao
          join [(ss063)] ss063 on ss063.filial    = ss027.filial
    Where ak_cc = pConta;

   -- Tipo de Inscricao do Cliente (Usa em varios Locais)
   if xBanco.cnpj is not null then
      sTipo := '2' || substring(xBanco.cnpj,1,14);
   else
      sTipo := '1' || substring(xBanco.cpf,1,14);
   end if;

   -- Verifica se existem registros selecionados ainda não incluídos em nenhuma remessa
-- If (Select Count(*) From [(fr3)] Where fr3_selecao = 1 And fbs_remessa Is Null) < 1 Then
--    raise '[[ATENÇÃO. Todos os títulos selecionados já foram incluídos numa remessa. Favor selecionar outros títulos.]]';
-- End If;

   -- Recupera o número da última remessa para este banco
   Select Coalesce(Max(frq_remessa), 0) + 1
     Into iRemessa
     From [(frq)]
    Where ak_cc = pConta;

   --Insere Registro da Remessa
   insert into [(frq)] (ak_cc,  frq_remessa, frq_data_g,        frq_user_g,        frq_doctos, frq_total)
                values (pConta, iRemessa,    CURRENT_TIMESTAMP, sys_user####???(), 0,          0);

   -- Apaga Registros da Tabela FR4
   delete from [(fr4)] where session = cSessao;


   -- INICIO DO REGISTRO HEADER DE ARQUIVO
   cTexto := '001';                                              --001/003-Codigo do banco
   cTexto := cTexto || '0000';                                   --004/007-Lote de serviço
   cTexto := cTexto || '0';                                      --008/008-Tipo de Registro
   cTexto := cTexto || repeat(' ',9);                            --009/017-uso Febraban
   cTexto := cTexto || sTipo;                                    --018/032-Tipo/Numero de Inscricao
   cTexto := cTexto || rpad(xBanco.convenio         ,09);        --033/041-convenio
   cTexto := cTexto || '0126';                                   --042/045-0126
   cTexto := cTexto || repeat(' ',5);                            --046/050-brancos
   cTexto := cTexto || '  ';                                     --051/052-brancos=producao, TS=teste
   cTexto := cTexto || sys_strzero(xBanco.a0_codag,05);          --053/057-Agência Mantenedora da Conta
   cTexto := cTexto || rpad(xBanco.a0_digito        ,01);        --058/058-Dígito Verificador da Agência
   cTexto := cTexto || sys_strzero(xBanco.ak_conta::integer,12); --059/070-Número da Conta Corrente
   cTexto := cTexto || rpad(xBanco.ak_digito        ,01);        --071/071-Dígito Verificador da Conta
   cTexto := cTexto || '0';                                      --072/072-0
   cTexto := cTexto || rpad(xBanco.razao            ,30);        --073/102-Nome da Empresa
   cTexto := cTexto || rpad('BANCO DO BRASIL'       ,30);        --103/132-Nome do Banco
   cTexto := cTexto || repeat(' ',10);                           --133/142-Uso Febraban
   cTexto := cTexto || '1';                                      --143/143-(1-Remessa 2-Retorno)
   cTexto := cTexto || To_Char(CURRENT_DATE, 'DDMMYYYY');        --144/151-Data de Geração do Arquivo
   cTexto := cTexto || To_Char(CURRENT_TIMESTAMP, 'HH24MISS');   --152/157-Hora de Geração do Arquivo
   cTexto := cTexto || sys_strzero(iRemessa, 06);                --158/163-Número Seqüencial do Arquivo
   cTexto := cTexto || '085';                                    --164/166-Nº da Versão do Layout do Arquivo
   cTexto := cTexto || '00000';                                  --167/171-Densidade de Gravação do Arquivo
   cTexto := cTexto || repeat(' ',20);                           --172/191-Para Uso Reservado do Banco
   cTexto := cTexto || sys_strzero(iRemessa, 06) ||
                       repeat(' ',14);                           --192/211-Para Uso Reservado da Empresa (Fixa a Remessa)
   cTexto := cTexto || repeat(' ',11);                           --212/222-nao definido no manual
   cTexto := cTexto || '   ';                                    --223/225-brancos
   cTexto := cTexto || '000';                                    --226/228-000
   cTexto := cTexto || '00';                                     --229/230-00
   cTexto := cTexto || '0000000000';                             --231/240-000

   -- Contador de Registros
   iRegistros := iRegistros + 1;

   --Insere registro
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RHA',    cTexto,    240 );
   -- FIM DO REGISTRO HEADER DE ARQUIVO




   -- INICIO DE OP, DOC, TED    SEGMENTO A
   lHeaderlote := False;
   iTipoPgto   := -1;

   for xDados in (select sao.ao_codtit,    sao.ao_parce,   frp.frp_tipo_pgto, sac.a9_codbanco, sac.a0_codag,     sac.ac_cc,
                         sao.ac_codforn,   sao.ao_emissao, sao.ao_vencto,     sao.recno,       sac.ac_cc_digito, sao.sao_num_documento,
                         upper(sys_limpa_campo(sfj.sfj_nome,False)) as sfj_nome,
                         coalesce(sao.ao_saldo ,0)                  as ao_saldo,
                         coalesce(sao.ao_descto,0)                  as ao_descto,
                         coalesce(sao.ao_multa, 0)                  as ao_multa,
                         coalesce(sao.ao_juros, 0)                  as ao_juros
                    from [(frp)]   frp
                    join [(sao)]   sao   on sao.ao_codtit  = frp.ao_codtit and sao.ao_parce = frp.ao_parce
                    join [(sfj)]   sfj   on sfj.sfj_pessoa = sao.ac_codforn
                    join [(sac)]   sac   on sac.ac_codforn = sfj.sfj_pessoa
                    join [(ss029)] ss029 on ss029.recfile  = frp.recno
                   where frp.frp_tipo_pgto in (15,16,17,18)                -- Doc / Ted
                     and sao.frq_remessa is null
                     and frp.session = cSessao
                   order by frp_tipo_pgto) loop
       if (not lHeaderlote) or
          (iTipoPgto <> xDados.frp_tipo_pgto) then

          lHeaderlote := True;
          iTipoPgto   := xDados.frp_tipo_pgto;

          lHeaderlote := True;

          -- Incrementa Lote
          iLotes := iLotes + 1;

          -- Inicializa Sequencial
          iSequencial := 1;

          -- Inicializa Totalizador Registros Lote
          iReglote    := 1;

          -- Inicializa Total de Pagamentos
          nValorLote  := 0;

          -- Header de Lote
          cTexto := '001';                                              --001/003-Codigo do banco
          cTexto := cTexto || sys_strzero(iLotes,4);                    --004/007-Lote de Servico
          cTexto := cTexto || '1';                                      --008/008-Tipo de Registro
          cTexto := cTexto || 'C';                                      --009/009-Tipo de Operacao
          cTexto := cTexto || '98';                                     --010/011-Tipo de Serviço
          cTexto := cTexto || '03';                                     --012/013-Forma de Lancamento
          cTexto := cTexto || '000';                                    --014/016-Versao do LayOut
          cTexto := cTexto || ' ';                                      --017/017-Uso Febraban
          cTexto := cTexto || sTipo;                                    --018/032-Tipo/Numero de Inscricao
          cTexto := cTexto || rpad(xBanco.convenio         ,09);        --033/041-convenio
          cTexto := cTexto || '0126';                                   --042/045-0126
          cTexto := cTexto || repeat(' ',5);                            --046/050-brancos
          cTexto := cTexto || '  ';                                     --051/052-brancos=producao, TS=teste
          cTexto := cTexto || sys_strzero(xBanco.a0_codag,05);          --053/057-Agência Mantenedora da Conta
          cTexto := cTexto || rpad(xBanco.a0_digito        ,01);        --058/058-Dígito Verificador da Agência
          cTexto := cTexto || sys_strzero(xBanco.ak_conta::integer,12); --059/070-Número da Conta Corrente
          cTexto := cTexto || rpad(xBanco.ak_digito        ,01);        --071/071-Dígito Verificador da Conta
          cTexto := cTexto || '0';                                      --072/072-0
          cTexto := cTexto || rpad(xBanco.razao            ,30);        --073/102-Nome da Empresa
          cTexto := cTexto || repeat(' ',40);                           --103/142-Mensagem
          cTexto := cTexto || rpad(xBanco.ender            ,30);        --143/172-endereço
          cTexto := cTexto || sys_strzero(xBanco.num::integer,05);      --173/177-Numero
          cTexto := cTexto || rpad(xBanco.compl            ,15);        --178/192-Complemento
          cTexto := cTexto || rpad(xBanco.cidade           ,20);        --193/212-Cidade
          cTexto := cTexto || rpad(xBanco.cep              ,08);        --213/220-Cep
          cTexto := cTexto || rpad(xbanco.uf               ,02);        --221/222-UF
          cTexto := cTexto || repeat(' ',08);                           --223/230-Uso Febraban
          cTexto := cTexto || repeat('0',10);                           --231/240-ocorrencias

          -- Contador de registros
          iRegistros := iRegistros + 1;

          -- Insere Registro
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHL',    cTexto,    240 );
          -- FIM DO HEADER DE LOTE

         -- Insere registro no historico do titulo
--         perform sys_log####???('SAO', xDados.Recno, format('Enviado pagamento eletrônico - Remessa nº %s - Banco: %s  - Conta: %s',
--                                iRemessa, xBanco.a9_codbanco, xBanco.ak_cc));

       end if;

       -- INICIO REGISTRO DETALHE - SEGMENTO <a>
       iSequencial := iSequencial + 1;

       cTexto := '001';                                                        --001/003-Codigo do banco
       cTexto := cTexto || sys_strzero(iLotes,4);                              --004/007-Lote de Servico
       cTexto := cTexto || '3';                                                --008/008 Registro Detalhe
       cTexto := cTexto || sys_strzero(iSequencial,5);                         --009/013-Sequencial
       cTexto := cTexto || 'A';                                                --014/014-Codigo segmento
       cTexto := cTexto || '0';                                                --015/015-Tipo de Movimento 0-inc 1-cons 3-est 5-alt 7-liq 9-exc
       cTexto := cTexto || '00';                                               --016/017-Instrução

       if    iTipoPgto = 14 then
          cTexto := cTexto || '000';
       elsif iTipoPgto in (15,16) then
          cTexto := cTexto || '700';
       else
          cTexto := cTexto || '018';                                           --018/020-cod cam compensacao
       end if;
       cTexto := cTexto || sys_strzero(sac.a9_codbanco,3);                     --021/023-codigo banco
       cTexto := cTexto || sys_strzero(sac.a0_codag,5);                        --024/028-Agencia
       cTexto := cTexto || ' ';                                                --029/029-branco
       cTexto := cTexto || rpad(sac.ac_cc,12);                                 --030/041-conta corrente
       cTexto := cTexto || rpad(sac.ac_cc_digito,1);                           --042/042-digito
       cTexto := cTexto || ' ';                                                --043/043-branco
       cTexto := cTexto || rpad(xDados.sfj_nome,30);                           --044/073-Nome Concessionaria/Orgao
       cTexto := cTexto || sys_strzero(xDados.ao_codtit,10) ||
                           sys_strzero(xDados.ao_parce,10);                    --123/142-Nosso Numero
       cTexto := cTexto || to_char(pData_Pgto,'DDMMYYYY');                     --094/101-Data do Pagamento
       cTexto := cTexto || 'BRL';                                              --102/104-moeda
       cTexto := cTexto || repeat('0',15);                                     --105/119-zeros
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_saldo,2,'',1);             --120/134-Valor
       cTexto := cTexto || repeat(' ',20);                                     --135/154-Nosso Numero
       cTexto := cTexto || repeat(' ',08);                                     --155/162-data Real do pagamento
       cTexto := cTexto || repeat(' ',15);                                     --163/177-valor real
       cTexto := cTexto || repeat(' ',40);                                     --178/217-mensagem
       cTexto := cTexto || '01';                                               --218/219-finalidade
       cTexto := cTexto || repeat(' ',10);                                     --220/229-brancos
       cTexto := cTexto || '0';                                                --230/230-emissao aviso
       cTexto := cTexto || repeat(' ',10);                                     --231/240-Ocorrencias

       -- Contador de Registros
       iRegistros := iRegistros + 1;
       iRegLote   := iRegLote   + 1;

       -- Contador de Titulos
       iTitulos   := iTitulos   + 1;

       -- Insere Registro
       Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                   Values  ( cSessao, 'RHD',    cTexto,    240 );

       --Soma Valor dos Pagamentos
       nValorLote := nValorLote + xDados.ao_saldo;
       nTtArquivo := nTtArquivo + xDados.ao_saldo;

       -- Atualiza o título com o número da remessa
       Update [(sao)] set frq_remessa = iRemessa, ak_cc = pConta
        where recno = xDados.recno;

       --Insere Registro na Tabela de remessas Geradas
       insert into [(frt)] (ao_codtit,        ao_parce,         ak_cc,         ac_codforn,
                           frt_vencto,       frt_valor,        frq_remessa,   frt_emissao)
                   values  (xDados.ao_codtit, xDados.ao_parce,  xBanco.ak_cc,  xDados.ac_codforn,
                            xDados.ao_vencto, xDados.ao_saldo,  iRemessa,      xDados.ao_emissao);

       --FIM REGISTRO DETALHE
   end loop;

   -- Testa se Executou processamento
   if lHeaderlote then
      iRegLote  := iRegLote    + 1;

      -- TRAILER DE LOTE
      cTexto := '001';                                            --001/003-Codigo do banco
      cTexto := cTexto || sys_strzero(iLotes,4);                  --004/007-Lote de Servico
      cTexto := cTexto || '5';                                    --008/008 Registro Detalhe
      cTexto := cTexto || repeat(' ',9);                          --009/017-Bancos
      cTexto := cTexto || sys_strzero(iRegLote,6);                --018/023-Quantidade de Registros
      cTexto := cTexto || sys_strzerodec(nValorLote,2,'',18);     --024/041-Somatoria Pagamentos
      cTexto := cTexto || repeat('0',18);                         --042/059-Zeros
      cTexto := cTexto || repeat('0',06);                         --060/065-Brancos
      cTexto := cTexto || repeat(' ',165);                        --066/230-Brancos
      cTexto := cTexto || repeat(' ',10);                         --231/240-Ocorrencias

      -- Contador de Registros
      iRegistros := iRegistros + 1;

      -- Insere Registro
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RTL',    cTexto,    240 );
   end if;
--====================FIM op/doc/ted






--==================================================================================================================
   -- INICIO DE PAGAMENTO DE TITULOS
   lHeaderlote := False;
   iTipoPgto   := -1;
   iRegLote    := 0;

   for xDados in (select sao.ao_codtit, sao.ao_parce, sao.sao_barra, vsfn.sfh_cnpj, vsfn.sfi_cpf, sao.ao_vencto,
                         sao.recno,     frp.frp_tipo_pgto,
                         sys_limpa_campo(vsfn.sfj_nome,False) as sfj_nome,
                         coalesce(sao.ao_saldo, 0)            as ao_saldo,
                         coalesce(sao.ao_descto,0)            as ao_descto,
                         coalesce(sao.ao_multa, 0)            as ao_multa,
                         coalesce(sao.ao_juros, 0)            as ao_juros,
                         case when substring(sao.sao_barra,1,3)::integer = xBanco.a9_codbanco then 1 else 2 end as ordem
                    from [(frp)]   frp
                    join [(sao)]   sao   on sao.ao_codtit  = frp.ao_codtit and sao.ao_parce = frp.ao_parce
                    join [(vsfn)]  vsfn  on vsfn.sfj_pessoa = sao.ac_codforn
                    join [(ss029)] ss029 on ss029.recfile = frp.recno
                   where frp.frp_tipo_pgto = 1                                -- Boletos Bancarios
                     and sao.sao_barra is not null                            -- Com codigo de barra
--                     and substring(sao.sao_barra,1,3) = xBanco.a9_codbanco::varchar   -- proprio banco
                   and sao.frq_remessa is null
                     and frp.session = cSessao
                order by ordem) loop
                -- coloco os titulos do proprio banco em primeiro lugar
       if (not lHeaderlote) or
          (iTipoPgto <> xDados.ordem) then

          lHeaderlote := True;
          iTipoPgto   := xDados.ordem;

          -- Incrementa Lote
          iLotes := iLotes + 1;

          -- Inicializa Sequencial
          iSequencial := 0;

          -- Inicializa Total de Pagamentos
          nValorLote := 0;

          -- Header de Lote
          cTexto := '001';                                                     --001/003-Codigo do banco
          cTexto := cTexto || sys_strzero(iLotes,4);                           --004/007-Lote de Servico
          cTexto := cTexto || '1';                                             --008/008-Tipo de Registro
          cTexto := cTexto || 'C';                                             --009/009-Tipo de Operacao
          cTexto := cTexto || '98';                                            --010/011-Tipo de Serviço
          if iTipoPgto = 1 then
             cTexto := cTexto || '30';                                         --012/013-Forma de Lancamento 30-PROPRIO BANCO
          else
             cTexto := cTexto || '31';
          end if;
          cTexto := cTexto || '000';                                           --014/016-Versao do LayOut
          cTexto := cTexto || ' ';                                             --017/017-Uso Febraban
          cTexto := cTexto || sTipo;                                           --018/032-Tipo/Numero de Inscricao
          cTexto := cTexto || rpad(xBanco.convenio         ,09);        --033/041-convenio
          cTexto := cTexto || '0126';                                   --042/045-0126
          cTexto := cTexto || repeat(' ',5);                            --046/050-brancos
          cTexto := cTexto || '  ';                                     --051/052-brancos=producao, TS=teste
          cTexto := cTexto || sys_strzero(xBanco.a0_codag,05);          --053/057-Agência Mantenedora da Conta
          cTexto := cTexto || rpad(xBanco.a0_digito        ,01);        --058/058-Dígito Verificador da Agência
          cTexto := cTexto || sys_strzero(xBanco.ak_conta::integer,12); --059/070-Número da Conta Corrente
          cTexto := cTexto || rpad(xBanco.ak_digito        ,01);        --071/071-Dígito Verificador da Conta
          cTexto := cTexto || '0';                                             --072/072-Dígito Verificador da Ag/Conta
          cTexto := cTexto || rpad(xBanco.razao,            30);               --073/102-Nome da Empresa
          cTexto := cTexto || repeat(' ',40);                                  --103/142-Mensagem
          cTexto := cTexto || rpad(xBanco.ender,            30);               --143/172-endereço
          cTexto := cTexto || rpad(xBanco.num,              05);               --173/177-Numero
          cTexto := cTexto || rpad(xBanco.compl,            15);               --178/192-Complemento
          cTexto := cTexto || rpad(xBanco.cidade,           20);               --193/212-Cidade
          cTexto := cTexto || rpad(xBanco.cep,              08);               --213/220-Cep
          cTexto := cTexto || rpad(xbanco.uf,               02);               --221/222-UF
          cTexto := cTexto || repeat(' ',8);                                   --223/230-Uso febraban
          cTexto := cTexto || repeat('0',10);                                  --231/240-ocorrencias

          -- Contador de Registros
          iRegistros := iRegistros + 1;
          iRegLote   := iRegLote   + 1;

          -- Insere os dados
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHL',    cTexto,    240 );

          -- FIM DO HEADER DE LOTE
       end if;

       -- INICIO REGISTRO DETALHE - SEGMENTO <J>
       iSequencial := iSequencial + 1;

       cTexto := '001';                                                        --001/003-Codigo do banco
       cTexto := cTexto || sys_strzero(iLotes,4);                              --004/007-Lote de Servico
       cTexto := cTexto || '3';                                                --008/008 Registro Detalhe
       cTexto := cTexto || sys_strzero(iSequencial,5);                         --009/013-Sequencial
       cTexto := cTexto || 'J';                                                --014/014-Codigo segmento
       cTexto := cTexto || '0';                                                --015/015-Tipo de Movimento 0-inc 1-cons 3-est 5-alt 7-liq 9-exc
       cTexto := cTexto || '00';                                               --016/017-Instrução
       cTexto := cTexto || substring(xDados.sao_barra,1,44);                   --018/061-banco favorecido
       cTexto := cTexto || rpad(xDados.sfj_nome,30);                           --062/091-Nome Concessionaria/Orgao
       cTexto := cTexto || to_char(xDados.ao_vencto,'DDMMYYYY');               --092/099-Data do Pagamento
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_saldo +
                                          xDados.ao_descto -
                                          xDados.ao_multa  -
                                          xDados.ao_juros,2,'',15);            --100/114-Valor
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_descto,2,'',15);           --115/129-desconto
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_multa +
                                          xDados.ao_juros,2,'',15);            --130/144-multa/juros
       cTexto := cTexto || to_char(pData_Pgto,'DDMMYYYY');                     --145/152-Data do Pagamento
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_saldo,2,'',15);            --153/167-Valor
       cTexto := cTexto || repeat('0',15);                                     --168/182-Quantidade de Moeda
       cTexto := cTexto || sys_strzero(xDados.ao_codtit,10) ||
                           sys_strzero(xDados.ao_parce,10);                    --183/202-Nosso Numero
       cTexto := cTexto || repeat(' ',20);                                     --203/222-camara centralizadora
       cTexto := cTexto || '09';                                               --223/224-Moeda
       cTexto := cTexto || repeat(' ',06);                                     --225/230-Uso febraban
       cTexto := cTexto || repeat('0',10);                                     --231/240-Ocorrencias

       -- Atualiza o título com o número da remessa
       Update [(sao)] set frq_remessa = iRemessa, ak_cc = pConta
        where recno = xDados.recno;

       -- Contador de Registros
       iRegistros := iRegistros + 1;
       iRegLote   := iRegLote   + 1;

       -- Contador de Titulos
       iTitulos := iTitulos + 1;

       -- Insere Registro
       Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                   Values  ( cSessao, 'RHD',    cTexto,    240 );


       --Bloco J52 - Boletos acima de 250.000,00
--     if xDados.ao_saldo >= 250000 then
          cTexto := '001';                                                     --001/003-bb
          cTexto := cTexto || sys_strzero(iLotes,4);                           --004/007-Lote de Servico
          cTexto := cTexto || '3';                                             --008/008-Tipo de Registro
          cTexto := cTexto || sys_strzero(iSequencial,5);                      --009/013-Sequencial
          cTexto := cTexto || 'J';                                             --014/014-segmento
          cTexto := cTexto || ' ';                                             --015/015-inclusao
          cTexto := cTexto || '00';                                            --016/017-inclusao
          cTexto := cTexto || '52';                                            --018/019-52
          if xBanco.cnpj is not null then                                      --020/035-tipo/inscricao
             cTexto := cTexto || '20' || rpad(xBanco.cnpj,14);
          else
             cTexto := cTexto || '10' || rpad(xBanco.cpf,14);
          end if;
          cTexto := cTexto || rpad(xBanco.razao,40);                           --036/075-Nome da Empresa
          if xDados.sfh_cnpj is not null then                                  --076/091-tipo/inscricao
             cTexto := cTexto || '20' || rpad(xDados.sfh_cnpj,14);
          else
             cTexto := cTexto || '10' || rpad(xDados.sfi_cpf,14);
          end if;
          cTexto := cTexto || rpad(xDados.sfj_nome,40);                        --092/131-Nome Concessionaria/Orgao
          cTexto := cTexto || repeat('0',16);                                  --132/147-avalista
          cTexto := cTexto || repeat(' ',40);                                  --148/187-nome
          cTexto := cTexto || repeat(' ',53);                                  --188/240-brancos
          -- Contador de Registros
          iRegistros := iRegistros + 1;
          iRegLote   := ireglote   + 1;

          -- Insere Registro
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHD',    cTexto,    240 );
--     end if;

       -- Insere registro no historico do titulo
      perform sys_log####???('SAO', xDados.Recno, format('Enviado pagamento eletrônico - Remessa nº %s - Banco: %s  - Conta: %s',
            iRemessa, xBanco.a9_codbanco, xBanco.ak_cc));

      --Soma Valor dos Pagamentos
       nValorLote := nValorLote + xDados.ao_saldo;
       nTtArquivo := nTtArquivo + xDados.ao_saldo;

       -- Atualiza o título com o número da remessa
       Update [(sao)] set frq_remessa = iRemessa, ak_cc = pConta
        where recno = xDados.recno;

       --FIM REGISTRO DETALHE
   end loop;

   -- Testa se Executou processamento
   if lHeaderlote then
      iRegLote := iRegLote + 1;
      -- TRAILER DE LOTE
      cTexto := '001';                                            --001/003-Codigo do banco
      cTexto := cTexto || sys_strzero(iLotes,4);                  --004/007-Lote de Servico
      cTexto := cTexto || '5';                                    --008/008 Registro Detalhe
      cTexto := cTexto || repeat(' ',9);                          --009/017-Bancos
      cTexto := cTexto || sys_strzero(iRegLote,6);                 --018/023-Quantidade de Registros
      cTexto := cTexto || sys_strzerodec(nValorLote,2,'',18);     --024/041-Somatoria Pagamentos
      cTexto := cTexto || repeat('0',24);                         --042/065-Somatoria Pagamentos Moeda
      cTexto := cTexto || repeat(' ',165);                        --066/230-Brancos
      cTexto := cTexto || repeat('0',10);                         --231/240-Ocorrencias

      -- Contador de Registros
      iRegistros := iRegistros + 1;

      -- Insere Registro
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RTL',    cTexto,    240 );
   end if;
   -- FIM DE PAGAMENTO DE BOLETOS DO PROPRIO BANCO
--==================================================================================================================




--==========================================================================================================================
   -- INICIO DE PAGAMENTO DE TRIBUTOS SEM CODIGO DE BARRAS
   lHeaderlote := False;
   iTipoPgto   := -1;

   for xDados in (select sao.sao_barra, sao.ao_vencto, sao.ao_codtit, sao.ao_parce, sao.recno,
                         sao.g005_cod,  sao.sao_identificador, frp.frp_tipo_pgto,
                         sys_limpa_campo(sfj.sfj_nome,False)  as sfj_nome,
                         coalesce(sao.ao_saldo,0)             as ao_saldo,
                         coalesce(sao.a2e_cod,'')             as a2e_cod,
                         coalesce(sao.sao_competencia,'')     as sao_competencia,
                         coalesce(sao.sao_gps_valor,0)        as sao_gps_valor,
                         coalesce(sao.sao_gps_outras,0)       as sao_gps_outras,
                         coalesce(sao.ao_multa,0)             as ao_multa,
                         coalesce(sao.ao_juros,0)             as ao_juros,
                         coalesce(sao.sao_lic_receita,'')     as sao_lic_receita,
                         coalesce(sao.sao_ie_munic_declar,'') as sao_ie_munic_declar,
                         coalesce(sao.sao_divida,'')          as sao_divida,
                         coalesce(sao.sao_parce_not,'')       as sao_parce_not,
                         coalesce(sao.sao_garesp_valor,0)     as sao_garesp_valor,
                         coalesce(sao.sao_dpvat_renavam,'')   as sao_dpvat_renavam,
                         coalesce(sz9.z7_uf,'')               as uf,
                         coalesce(sz9.sz9_cidade,'')          as sz9_cidade,
                         coalesce(sao.sao_dpvat_placa,'')     as sao_dpvat_placa,
                         coalesce(sao.sao_lic_retirada,'')    as sao_lic_retirada,
                         coalesce(sao.sao_dpvat_ano,'')       as sao_dpvat_ano
                    from [(frp)]   frp
                    join [(sao)]   sao   on sao.ao_codtit  = frp.ao_codtit and sao.ao_parce = frp.ao_parce
                    join [(sfj)]   sfj   on sfj.sfj_pessoa = sao.ac_codforn
                    join [(ss029)] ss029 on ss029.recfile = frp.recno
               left join [(sz9)] sz9     on sz9.sz9_municipio = sao.sao_dpvat_munic
                   where frp.frp_tipo_pgto in (2,3,4,5,6,7,8,9,10)
                     and sao.sao_barra is null
                     and sao.frq_remessa is null
                     and frp.session = cSessao) loop
       if (not lHeaderlote) or
          (iTipoPgto <> xDados.frp_tipo_pgto) then

          lHeaderlote := True;
          iTipoPgto   := xDados.frp_tipo_pgto;

          -- Incrementa Lote
          iLotes := iLotes + 1;

          -- Inicializa Sequencial
          iSequencial := 0;

          -- Inicializa Total de Pagamentos
          nValorLote := 0;

          -- Header de Lote
          cTexto := '001';                                                     --001/003-Codigo do banco
          cTexto := cTexto || sys_strzero(iLotes,4);                           --004/007-Lote de Servico
          cTexto := cTexto || '1';                                             --008/008-Tipo de Registro
          cTexto := cTexto || 'C';                                             --009/009-Tipo de Operacao
          cTexto := cTexto || '98';                                            --010/011-Tipo de Serviço

          if    xDados.frp_tipo_pgto = 2 then   -- Gps                         --012/013-Forma de Lancamento
             cTexto := cTexto || '17';
--        elsif xDados.frp_tipo_pgto = 4 then   -- GRF
--           raise '[[opçao nao implementada/testada]]';
          elsif xDados.frp_tipo_pgto = 7 then   -- Gare-Sp-Icms
             cTexto := cTexto || '22';
          elsif xDados.frp_tipo_pgto = 8 then   -- Gare-Sp Itcmd
             cTexto := cTexto || '24';
          elsif xDados.frp_tipo_pgto = 9 then   -- Gare-Sp DR
             cTexto := cTexto || '23';
          elsif xDados.frp_tipo_pgto =10 then   -- darf
             cTexto := cTexto || '16';
          else
             raise '[[ATENÇÃO. Não foi definido lay-out para o Tributo: %. Verifique!]]',xDados.frp_tipo_pgto;
          end if;
          cTexto := cTexto || '   ';                                           --014/016-Versao do LayOut
          cTexto := cTexto || ' ';                                             --017/017-Uso Febraban
          cTexto := cTexto || sTipo;                                           --018/032-Tipo/Numero de Inscricao
          cTexto := cTexto || rpad(xBanco.convenio         ,09);        --033/041-convenio
          cTexto := cTexto || '0126';                                   --042/045-0126
          cTexto := cTexto || repeat(' ',5);                            --046/050-brancos
          cTexto := cTexto || '  ';                                     --051/052-brancos=producao, TS=teste
          cTexto := cTexto || sys_strzero(xBanco.a0_codag,05);          --053/057-Agência Mantenedora da Conta
          cTexto := cTexto || rpad(xBanco.a0_digito        ,01);        --058/058-Dígito Verificador da Agência
          cTexto := cTexto || sys_strzero(xBanco.ak_conta::integer,12); --059/070-Número da Conta Corrente
          cTexto := cTexto || rpad(xBanco.ak_digito        ,01);        --071/071-Dígito Verificador da Conta
          cTexto := cTexto || '0';                                             --072/072-Dígito Verificador da Ag/Conta
          cTexto := cTexto || rpad(xBanco.razao,            30);               --073/102-Nome da Empresa
          cTexto := cTexto || repeat(' ',40);                                  --103/142-Mensagem
          cTexto := cTexto || rpad(xBanco.ender,            30);               --143/172-endereço
          cTexto := cTexto || rpad(xBanco.num,              05);               --173/177-Numero
          cTexto := cTexto || rpad(xBanco.compl,            15);               --178/192-Complemento
          cTexto := cTexto || rpad(xBanco.cidade,           20);               --193/212-Cidade
          cTexto := cTexto || rpad(xBanco.cep,              08);               --213/220-Cep
          cTexto := cTexto || rpad(xbanco.uf,               02);               --221/222-UF
          cTexto := cTexto || '01';                                            --223/224-Forma de Pagamento 1-cc 2-empr 3-cartao
          cTexto := cTexto || repeat(' ',6);                                   --225/230-Uso Febraban
          cTexto := cTexto || repeat('0',10);                                  --231/240-ocorrencias

          -- Contador de Registros
          iRegistros := iRegistros + 1;

          -- Insere os dados
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHL',    cTexto,    240 );

          -- FIM DO HEADER DE LOTE
       end if;

       -- INICIO REGISTRO DETALHE - SEGMENTO <N> SEM CODIGO DE BARRAS
       iSequencial := iSequencial + 1;

       cTexto := '001';                                                        --001/003-Codigo do banco
       cTexto := cTexto || sys_strzero(iLotes,4);                              --004/007-Lote de Servico
       cTexto := cTexto || '3';                                                --008/008 Registro Detalhe
       cTexto := cTexto || sys_strzero(iSequencial,5);                         --009/013-Sequencial
       cTexto := cTexto || 'N';                                                --014/014-Codigo segmento
       cTexto := cTexto || '0';                                                --015/015-Tipo de Movimento 0-inc 1-cons 3-est 5-alt 7-liq 9-exc
       cTexto := cTexto || '00';                                               --016/017-Instrução
       cTexto := cTexto || sys_strzero(xDados.ao_codtit,10) ||
                           sys_strzero(xDados.ao_parce,10);                    --123/142-Nosso Numero
       cTexto := cTexto || repeat(' ',20);                                     --038/057-Numero Banco
       cTexto := cTexto || rpad(xDados.sfj_nome,30);                           --058/087-Nome Concessionaria/Orgao
       cTexto := cTexto || to_char(pData_Pgto,'DDMMYYYY');                     --088/095-Data do Pagamento
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_saldo,2,'',15);            --096/110-Valor

       -- Pagamento de GPS
       if xDados.frp_tipo_pgto = 2 then
          cTexto := cTexto || rpad(xDados.a2e_cod,6);                          --111/116-Receita
          cTexto := cTexto || '0' || sTipo;                                    --117/132-Tipo/Inscricao
          cTexto := cTexto || '17';                                            --133/134-Tipo de Tributo
          cTexto := cTexto || rpad(xDados.sao_competencia,6);                  --135/140-Competencia
          cTexto := cTexto || sys_strzerodec(xDados.ao_saldo,2,'',15);         --141/155-Valor
          cTexto := cTexto || sys_strzerodec(xDados.sao_gps_outras,2,'',15);   --156/170-Outras Entidades
          cTexto := cTexto || sys_strzerodec(xDados.ao_multa,2,'',15);         --171/185-Atualizacao Monetaria
          cTexto := cTexto || repeat(' ',45);                                  --186/230-Uso Febraban
       -- Pagamento de DARF??
       elsif xDados.frp_tipo_pgto = 10 then
          raise '[[opçao nao implementada/testada]]';
       -- Pagamento de GARE
       elsif xDados.frp_tipo_pgto in (7,8,9) then
          cTexto := cTexto || rpad(xDados.sao_lic_receita,1,06);               --111/116-Receita
          cTexto := cTexto || rpad(xDados.g005_cod         ,02);               --117/118-Tipo
          cTexto := cTexto || rpad(xDados.sao_identificador,14);               --119/132-Inscricao
          cTexto := cTexto || '22';                                            --133/134-Tipo de Tributo
          cTexto := cTexto || to_char(xDados.ao_vencto,'DDMMYYYY');            --135/142-Data do Vencimento
          cTexto := cTexto || rpad(xDados.sao_ie_munic_declar,12);             --143/154-IE
          cTexto := cTexto || rpad(xDados.sao_divida         ,13);             --155/167-Valor
          cTexto := cTexto || rpad(xDados.sao_competencia    ,06);             --168/173-Competencia
          cTexto := cTexto || rpad(xDados.sao_parce_not      ,13);             --174/186-Parcela
          cTexto := cTexto || sys_strzerodec(xDados.sao_garesp_valor,2,'',15); --187/201-Valor da Receita
          cTexto := cTexto || sys_strzerodec(xDados.ao_juros,2,'',15);         --202/215-Juros
          cTexto := cTexto || sys_strzerodec(xDados.ao_multa,2,'',15);         --216/229-Atualizacao Monetaria
          cTexto := cTexto || ' ';                                             --230/230-Uso Febraban
       -- Pagamento de DARJ??
       elsif xDados.frp_tipo_pgto = 7 then
          raise '[[opçao nao implementada/testada]]';
       end if;
       cTexto := cTexto || repeat(' ',10);                                     --Ocorrencias

       -- Contador de registros
       iRegistros := iRegistros + 1;

       -- Contador de Titulos
       iTitulos := iTitulos + 1;

       -- Insere Registro
       Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                   Values  ( cSessao, 'RHD',    cTexto,    240 );

       -- Insere registro no historico do titulo
      perform sys_log####???('SAO', xDados.Recno, format('Enviado pagamento eletrônico - Remessa nº %s - Banco: %s  - Conta: %s',
            iRemessa, xBanco.a9_codbanco, xBanco.ak_cc));

       --Soma Valor dos Pagamentos
       nValorLote := nValorLote + xDados.ao_saldo;
       nTtArquivo := nTtArquivo + xDados.ao_saldo;

       -- Atualiza o título com o número da remessa
       Update [(sao)] set frq_remessa = iRemessa, ak_cc = pConta
        where recno = xDados.recno;

       --FIM REGISTRO DETALHE
   end loop;

   -- Testa se Executou processamento
   if lHeaderlote then
      -- TRAILER DE LOTE
      cTexto := sys_strzero(xBanco.a9_codbanco,3);                --001/003-Codigo do banco
      cTexto := cTexto || sys_strzero(iLotes,4);                  --004/007-Lote de Servico
      cTexto := cTexto || '5';                                    --008/008 Registro Detalhe
      cTexto := cTexto || repeat(' ',9);                          --009/017-Bancos
      cTexto := cTexto || sys_strzero(iSequencial,6);             --018/023-Quantidade de Registros
      cTexto := cTexto || sys_strzerodec(nValorLote,2,'',18);     --024/041-Somatoria Pagamentos
      cTexto := cTexto || repeat(' ',189);                        --042/230-Brancos
      cTexto := cTexto || repeat('0',10);                         --231/240-Ocorrencias

      -- Contador de Registros
      iRegistros := iRegistros + 1;

      -- Insere Registro
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RTL',    cTexto,    240 );
   end if;
   -- FIM DE PAGAMENTO DE TRIBUTOS SEM CODIGO DE BARRAS
--===================================================================================================================





   -- INICIO DE PAGAMENTO DE TRIBUTOS COM CODIGO DE BARRAS SEGMENTO O
   lHeaderlote := False;

   for xDados in (select sao.sao_barra,     sao.ao_vencto, sao.ao_codtit,         sao.ao_parce, sao.a35_codigo, sao.recno,
                         frp.frp_tipo_pgto, sao.g005_cod,  sao.sao_identificador,
                         sys_limpa_campo(sfj.sfj_nome,False) as sfj_nome,
                         coalesce(sao.ao_saldo,0)            as ao_saldo,
                         coalesce(sao.sao_grf_lacre,'')      as sao_grf_lacre
                    from [(frp)]   frp
                    join [(sao)]   sao   on sao.ao_codtit  = frp.ao_codtit and sao.ao_parce = frp.ao_parce
                    join [(sfj)]   sfj   on sfj.sfj_pessoa = sao.ac_codforn
                    join [(ss029)] ss029 on ss029.recfile = frp.recno
                   where frp.frp_tipo_pgto in (2,3,4,5,6,7,8,9,10)
                     and sao.sao_barra is not null
                     and sao.frq_remessa is null
                     and frp.session = cSessao) loop

       if (not lHeaderlote) or
          (xDados.frp_tipo_pgto <> iTipoPgto) then

          lHeaderlote := True;

          -- Incrementa Lote
          iLotes := iLotes + 1;

          -- Inicializa Sequencial
          iSequencial := 0;

          -- Inicializa Total de Pagamentos
          nValorLote := 0;

          -- Header de Lote
          cTexto := '001';                                              --001/003-Codigo do banco
          cTexto := cTexto || sys_strzero(iLotes,4);                    --004/007-Lote de Servico
          cTexto := cTexto || '1';                                      --008/008-Tipo de Registro
          cTexto := cTexto || 'C';                                      --009/009-Tipo de Operacao
          cTexto := cTexto || '98';                                     --010/011-Tipo de Serviço
          cTexto := cTexto || '11';                                     --012/013-Forma de Lancamento
          cTexto := cTexto || '000';                                    --014/016-Versao do LayOut
          cTexto := cTexto || ' ';                                      --017/017-Uso Febraban
          cTexto := cTexto || sTipo;                                    --018/032-Tipo/Numero de Inscricao
          cTexto := cTexto || rpad(xBanco.convenio         ,09);        --033/041-convenio
          cTexto := cTexto || '0126';                                   --042/045-0126
          cTexto := cTexto || repeat(' ',5);                            --046/050-brancos
          cTexto := cTexto || '  ';                                     --051/052-brancos=producao, TS=teste
          cTexto := cTexto || sys_strzero(xBanco.a0_codag,05);          --053/057-Agência Mantenedora da Conta
          cTexto := cTexto || rpad(xBanco.a0_digito        ,01);        --058/058-Dígito Verificador da Agência
          cTexto := cTexto || sys_strzero(xBanco.ak_conta::integer,12); --059/070-Número da Conta Corrente
          cTexto := cTexto || rpad(xBanco.ak_digito        ,01);        --071/071-Dígito Verificador da Conta
          cTexto := cTexto || '0';                                      --072/072-0
          cTexto := cTexto || rpad(xBanco.razao            ,30);        --073/102-Nome da Empresa
          cTexto := cTexto || repeat(' ',40);                           --103/142-Mensagem
          cTexto := cTexto || rpad(xBanco.ender            ,30);        --143/172-endereço
          cTexto := cTexto || rpad(xBanco.num              ,05);        --173/177-Numero
          cTexto := cTexto || rpad(xBanco.compl            ,15);        --178/192-Complemento
          cTexto := cTexto || rpad(xBanco.cidade           ,20);        --193/212-Cidade
          cTexto := cTexto || rpad(xBanco.cep              ,08);        --213/220-Cep
          cTexto := cTexto || rpad(xbanco.uf               ,02);        --221/222-UF
          cTexto := cTexto || repeat(' ',08);                           --223/230-Uso Febraban
          cTexto := cTexto || repeat('0',10);                           --231/240-ocorrencias

          -- Contador de registros
          iRegistros := iRegistros + 1;

          -- Insere Registro
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHL',    cTexto,    240 );
          -- FIM DO HEADER DE LOTE
       end if;

       -- INICIO REGISTRO DETALHE - SEGMENTO <O> COM CODIGO DE BARRAS
       iSequencial := iSequencial + 1;

       cTexto := '001';                                                 --001/003-Codigo do banco
       cTexto := cTexto || sys_strzero(iLotes,4);                       --004/007-Lote de Servico
       cTexto := cTexto || '3';                                         --008/008 Registro Detalhe
       cTexto := cTexto || sys_strzero(iSequencial,5);                  --009/013-Sequencial
       cTexto := cTexto || 'O';                                         --014/014-Codigo segmento
       cTexto := cTexto || '0';                                         --015/015-Tipo de Movimento 0-inc 1-cons 3-est 5-alt 7-liq 9-exc
       cTexto := cTexto || '00';                                        --016/017-Instrução
       cTexto := cTexto || rpad(xDados.sao_barra              ,44);     --018/061-Codigo de Barras
       cTexto := cTexto || rpad(xDados.sfj_nome               ,30);     --062/091-Nome Concessionaria/Orgao
       cTexto := cTexto || to_char(xDados.ao_vencto,'DDMMYYYY');        --092/099-Data do Vencimento
       cTexto := cTexto || to_char(pData_Pgto,'DDMMYYYY');              --100/107-Data do Pagamento
       cTexto := cTexto || Sys_StrzeroDec(xDados.ao_saldo,2,'',15);     --108/122-Valor
       cTexto := cTexto || sys_strzero(xDados.ao_codtit,10) ||
                           sys_strzero(xDados.ao_parce,10);             --123/142-Nosso Numero
       cTexto := cTexto || repeat(' ',20);                              --143/162-Numero Banco
       cTexto := cTexto || repeat(' ',68);                              --163/230-Uso Febraban
       cTexto := cTexto || repeat('0',10);                              --231/240-Ocorrencias

       -- Contador de registros
       iRegistros := iRegistros + 1;

       -- Contador de Titulos
       iTitulos := iTitulos + 1;

       -- Insere Registro
       Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                   Values  ( cSessao, 'RHD',    cTexto,    240 );

       -- Se for FGTS tipos de recolhimento: 418,604,327,337,345 é obrigatorio informar tipo W
       if xDados.a35_codigo in ('418','604','327','337','345') then
          iSequencial := iSequencial + 1;

          cTexto := '001';                                              --001/003-Codigo do banco
          cTexto := cTexto || sys_strzero(iLotes,4);                    --004/007-Lote de Servico
          cTexto := cTexto || '3';                                      --008/008 Registro Detalhe
          cTexto := cTexto || sys_strzero(iSequencial,5);               --009/013-Sequencial
          cTexto := cTexto || 'W';                                      --014/014-Codigo segmento
          cTexto := cTexto || '1';                                      --015/015-Sequencial
          cTexto := cTexto || '1';                                      --016/016-informacoes
          cTexto := cTexto || repeat(' ',80);                           --017/096-Ocorrencias
          cTexto := cTexto || repeat(' ',80);                           --097/176-Ocorrencias
          cTexto := cTexto || '01';                                     --177/178-identificador
          cTexto := cTexto || rpad(xDados.a35_codigo,   06);            --179/184-codigo receita
          cTexto := cTexto || rpad(xDados.g005_cod,     02);            --185/186-tipo
          cTexto := cTexto || rpad(xDados.sao_identificador,14);        --187/200-identificacao
          cTexto := cTexto || repeat(' ',16);                           --201/216-identificador
          cTexto := cTexto || rpad(xDados.sao_grf_lacre,11);            --217/227-Lacre
          cTexto := cTexto || ' ';                                      --228/228-branco
          cTexto := cTexto || repeat(' ',02);                           --229/230-uso febraban
          cTexto := cTexto || repeat('0',12);                           --231/240-Ocorrencias

          -- Contador de Registros
          iRegistros := iRegistros + 1;

          -- Insere Registro
          Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                      Values  ( cSessao, 'RHD',    cTexto,    240 );


         -- Insere registro no historico do titulo
         perform sys_log####???('SAO', xDados.Recno, format('Enviado pagamento eletrônico - Remessa nº %s - Banco: %s  - Conta: %s',
            iRemessa, xBanco.a9_codbanco, xBanco.ak_cc));

      end if;

       -- Atualiza o título com o número da remessa
       Update [(sao)] set frq_remessa = iRemessa, ak_cc = pConta
        where recno = xDados.recno;

       --Soma Valor dos Pagamentos
       nValorLote := nValorLote + xDados.ao_saldo;
       nTtArquivo := nTtArquivo + xdados.ao_saldo;
       --FIM REGISTRO DETALHE
   end loop;

   -- Testa se Executou processamento
   if lHeaderlote then
      -- TRAILER DE LOTE
      cTexto := '001';                                                  --001/003-Codigo do banco
      cTexto := cTexto || sys_strzero(iLotes,4);                        --004/007-Lote de Servico
      cTexto := cTexto || '5';                                          --008/008 Registro Detalhe
      cTexto := cTexto || repeat(' ',9);                                --009/017-Bancos
      cTexto := cTexto || sys_strzero(iSequencial,6);                   --018/023-Quantidade de Registros
      cTexto := cTexto || sys_strzerodec(nValorLote,2,'',18);           --024/041-Somatoria Pagamentos
      cTexto := cTexto || repeat(' ',189);                              --042/230-Brancos
      cTexto := cTexto || repeat('0',10);                               --231/240-Ocorrencias

      -- Contador de Registros
      iRegistros := iRegistros + 1;

      -- Insere registro
      Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
                  Values  ( cSessao, 'RTL',    cTexto,    240 );
   end if;
   -- FIM DE PAGAMENTO DE TRIBUTOS COM CODIGO DE BARRAS




   -- INICIO DO REGISTRO TRAILER DE ARQUIVO

   --incrementa registro pois soma o ultimo registro
   iRegistros := iRegistros + 1;

   cTexto := sys_strzero(xBanco.a9_codbanco,3);                  --001/003-Codigo do banco
   cTexto := cTexto || '9999';                                   --004/007-Lote de Serviço
   cTexto := cTexto || '9';                                      --008/008-Tipo de Registro
   cTexto := cTexto || repeat(' ',9);                            --009/017-Uso Exclusivo FEBRABAN/CNAB
   cTexto := cTexto || Sys_Strzero(iLotes, 06);                  --018/023-Quantidade Lotes no arquivo
   cTexto := cTexto || Sys_Strzero(iRegistros,6);                --024/029-Quantidade de Registros
   cTexto := cTexto || '000000';                                 --030/035-Quantidade de Contas
   cTexto := cTexto || repeat(' ',205);                          --036/240-uso Febraban

   -- Insere Registro
   Insert Into [(fr4)] ( session, fr4_tipo, fr4_texto, fr4_tamanho )
               Values  ( cSessao, 'RHA',    cTexto,    240 );
   -- FIM DO REGISTRO TRAILER DE ARQUIVO


   -- Atualiza Registro da Remessa
   Update [(frq)] set frq_doctos = iTitulos, frq_total = nTtArquivo
    where ak_cc = pConta
      and frq_remessa = iRemessa;

   out_res := 1;
End;
$$ language 'plpgsql';
