/**
   Trigger de Tela da tabela nfk - NFS-e

	@author    Fabio Carvalho
	@date      15/09/2011
	@trigger

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   04/07/2012 20:45:00  v1    Wagner Mobile Costa
      [+] Incluir a sugestão do código do serviço definido no cliente
*/
Create or Replace Function scr_00085_nfk####???
(  out out_res integer )
As $$
Declare
   iCliente  [(nfk)].a1_codcli%type;
   xCursor   Record;
   iFatura   [(nfk)].se2_ctrl%type;
Begin
   -- Se houve modificação no código do cliente atualiza os endereços
   if sys_042modified####???('NFK', 'a1_codcli') = 1 then
      -- Obtem o código da pessoa
      iCliente := sys_042integer2####???('NFK', 'a1_codcli');

      -- Atualiza o código da pessoa
      perform sys_042integer_wr####???('NFK', 'a1_codcli', iCliente);
   else
      iCliente := sys_042integer2####???('NFK', 'a1_codcli');
   end if;

   -- Informa a condicao de pagamento padrao
   select sa8.fa_codcond, sa8.a2b_recno
     into xCursor
     from [(sa8)] sa8
    where sa8.a1_codcli = iCliente;
    
   perform sys_042integer_wr####???('NFK', 'fa_codcond', xCursor.fa_codcond);
   perform sys_042integer_wr####???('NFK', 'nfk_cod_trib_mun', xCursor.a2b_recno);
   
   -- Atualiza as dependencias
   perform scr_00108_nfk####???();
   
   -- Atualiza Endereço
   if sys_042modified####???('NFK', 'a1_codcli') = 1 then
      -- Obtem endereços
      if iCliente is not null then
         -- Busca o endereço de faturamento mais recente do cliente
         iFatura  := mc_00205####???(iCliente);
      end if;

      -- Preenche endereço de faturamento
      perform sys_042integer_wr####???('NFK', 'se2_ctrl', iFatura);
   end if;

   out_res := 1;
End;
$$ language plpgsql;