/*==================================================================================================================================
| Empresa..: MultCont Informática                                                                                                  |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Autor....: Jurandy da Silva Costa                                                                                                |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Data.....: 07/09/2009 12:30:00                                                                                                   |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Tipo.....: Stored Procedure                                                                                                      |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Descrição: Atualiza tabela dinâmica de filtros dinamica para apresentar apenas produtos do cliente na nota de saídas             |
| -------------------------------------------------------------------------------------------------------------------------------- |
==================================================================================================================================*/
Create or Replace Function scr_00041_sg1####???( out out_res Integer ) As $$
Declare

   iSerialNF    [(sai)].sai_serial%type;    -- Número serial da nota de saída
   ia1_codcli   [(sai)].a1_codcli%type;     -- Código do Cliente
   cSessao      [(ss027)].session%type;     -- Sessao ativa no banco

Begin
   out_res := 0;
   cSessao := sys_session();
   -- Recupera o serial da nota fiscal de saída
   iSerialNF := sys_042integer####???('sai_serial');
   -- Só executa o processamento para notas fiscais Avulsas
   If (Select sai_avulso From [(sai)] Where sai_serial = iSerialNF) = 1 Then
      -- deleta sessão se existir
      delete from [(ss100)] where session = cSessao and codtable = 'VSA3_1';
      -- Recupera o código do cliente da nota de saída
      select a1_codcli into ia1_codcli
        from [(sai)]
       where sai_serial = iSerialNF;

      -- Gera o filtro com o código do cliente
      insert into [(ss100)](session, codtable, stmt)
          values (cSessao, 'VSA3_1', '([vsa3_1.b1_codpro]) in (Select b1_codpro From [(SAJ)] Where sai_serial = ' ||
                  sys_strzero(iSerialNF, 8) || ')' );
   End If;

   out_res := 1;
end;
$$ language 'plpgsql'
