/**
   Estoque - Exibe erro se a data informa for anterior a data de conciliação

	@author    Ricardo Gonçalves
	@date      14/02/2018
	@trigger
   
   @param in_pessoa  código do proprietário do estoque
   @param in_prod código do material que será verificado
   @param in_ficha código da ficha de estoque que deve ser checada
   @param in_data data que será verificada
   
   @return 1 caso esteja conciliado ou 0 caso contrário

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso      
*/
Create or Replace Function mc_01107####???(
   in in_pessoa integer,
   in in_prod varchar,
   in in_ficha integer,
   in in_data date) 
Returns integer As
$$
Declare
   r  record;
Begin   
   if mc_01106####???(in_pessoa, in_prod, in_ficha, in_data) = 1 then
      -- Obter a data de conciliação do estoque
      select p.b1_nome, pe.sfj_nome, f.a4i_descri, a12_data
        into r
        from [(a12)] k
             join [(sb1)] p
               on k.b1_codpro = p.b1_codpro
             join [(sfj)] pe
               on pe.sfj_pessoa = k.sfj_pessoa
             join [(a4i)] f
               on f.a4i_tipo = k.a4i_tipo
       where k.sfj_pessoa = in_pessoa
         and k.b1_codpro = in_prod
         and k.a4i_tipo = in_ficha 
         and k.a12_evento = -1
       order by k.a12_data desc
       limit 1;
   
      raise '[[O estoque do item "% - %" para ficha "% - %" da pessoa "% - %" está conciliado até %. Registre movimentos após esta data!]]', 
         in_prod, r.b1_nome, in_ficha, r.a4i_descri, in_pessoa, r.sfj_nome, to_char(r.a12_data, 'DD/MM/YYYY');      
   end if;
   
   return 1;
End;
$$
language plpgsql;
