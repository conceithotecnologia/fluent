/**
   Trigger para executar operações na Reserva (Cancelamento do Faturamento)

   @author    Wagner Mobile Costa
   @date      02/03/2010
   @trigger   LP2 A I

   Histórico
   ---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
   02/03/2010 20:00:00 v.1.1 Wagner Mobile Costa
     [+] Criar opção que permite o usuário cancelar o faturamento de uma reserva
*/
Create or Replace Function mc_01047####??? ( )
Returns trigger
As $$
begin
   if tg_op <> 'INSERT' Then
      raise '[[O histórico de operações da reserva não pode sofrer mudanças.]]';
      Return old;
   end if;

   if tg_op <> 'DELETE' then
      if (select count(*) from [(lom)] where lom_id = new.lom_id and lom_status = 3 and lom_status_fatur = 1) = 0 then
         raise '[[Só é permitido cancelar o faturamento de reservas em digitação e encerradas pelo site. Verifique!]]';
      end if;

      update [(lom)] set lom_status_fatur = 3 where lom_id = new.lom_id;

      return new;
   else
      return old;
   end if;
end;
$$ language 'plpgsql'