/*==================================================================================================================================
| Empresa..: MultCont Informática                                                                                                  |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Autor....: Jurandy da Silva Costa                                                                                                |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Data.....: 06/10/2009 20:30:00                                     Alterado.: 18/05/2010                                         |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Tipo.....: Stored Procedure                                                                                                      |
| -------------------------------------------------------------------------------------------------------------------------------- |
| Descrição: Atualiza tabela dinâmica de filtros para apresentar apenas as previsões associadas a esta natureza e período          |
| -------------------------------------------------------------------------------------------------------------------------------- |
==================================================================================================================================*/
Create or Replace Function scr_00046_scl####???( out out_res Integer ) As $$
Declare

   iNroTitulo   [(sao)].ao_codtit%type;     -- Número do título
   iNrParcela   [(sao)].ao_parce%type;      -- Número da parcela
   cContaBco    [(sao)].ak_cc%type;         -- Número da conta bancária
   dDataVence   [(sao)].ao_vencto%type;     -- Data de vencimento
   iNatureza    [(scl)].f1_codnat%type;     -- Código da natureza financeira
   iRecnoFC0    [(scl)].fc0_recno%type;     -- Registro na tabela de previsões
   iRecnoFPV    [(scl)].fc0_recno%type;     -- Registro na tabela de previsões
   cSessao      [(ss027)].session%type;     -- Sessao ativa no banco

   iPrevisoes   Integer;

Begin
   out_res := 0;
   cSessao := sys_session();
   -- Recupera o número do título e a natureza financeira
   iNroTitulo := sys_042integer####???('ao_codtit');
   iNrParcela := sys_042integer####???('ao_parce');
   iNatureza  := sys_042integer####???('f1_codnat');
   iRecnoFPV  := sys_042integer####???('fco_recno');
   -- Só executa o processamento depois que o usuário informar a natureza
   If iNatureza Is Not Null Then
      -- deleta sessão se existir
      delete from [(ss100)] where session = cSessao and codtable = 'FPV';
      -- Recupera o dados no cabeçalho do título
      select Coalesce(ak_cc, 'NÃO INFORMADA'), ao_vencto into cContaBco, dDataVence
        from [(sao)]
       where ao_codtit = iNroTitulo
         and ao_parce  = iNrParcela;
      -- Se a conta foi informada busca uma previsão para associar ao lançamento
      iPrevisoes := 0;
      Select Count(*), Max(recno) Into iPrevisoes, iRecnoFC0
        From [(fpv)]
       Where f1_codnat = iNatureza
         And (ak_cc = cContaBco Or ak_cc Is Null)
         And fc0_dtvence <= dDataVence
         And fc0_dtfinal >= dDataVence;
      If iPrevisoes = 1 Then
         -- Se encontrou apenas uma previsão financeira atualiza e desabilita o campo de vinculo
         Update [(ss042)]
            Set integer_ = iRecnoFC0, enabled = 0
          Where session   = cSessao
            And Columnname = 'fc0_recno';
      Else
         -- Se encontrou mais de uma previsão financeira apenas habilita o campo de vinculo
         If iPrevisoes = 0 Then
            Update [(ss042)]
               Set integer_ = Null, enabled = 0
             Where session   = cSessao
              And Columnname = 'fc0_recno';
         Else
            Update [(ss042)]
               Set enabled  = 1
             Where session   = cSessao
               And Columnname = 'fc0_recno';
         End If;
      End If;
      -- Gera o filtro com os dados do cabeçalho do título
      insert into [(ss100)](session, codtable, stmt)
          values (cSessao, 'FPV', '([fpv.f1_codnat]) = ' || sys_strzero(iNatureza, 8)  || ' AND ' ||
                                  '(([fpv.ak_cc]) Is Null Or ([fpv.ak_cc]) = ' || quote_literal(cContaBco) || ') AND ' ||
                                  '([fpv.fc0_dtvence]) <= ' || quote_literal(dDataVence) || ' AND ' ||
                                  '([fpv.fc0_dtfinal]) >= ' || quote_literal(dDataVence));
   End If;

   out_res := 1;
end;
$$ language 'plpgsql'
