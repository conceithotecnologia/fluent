/**
   Preenche campos antes do encerramento do doc. de classificação

	@author    Ricardo Gonçalves
	@date      10/10/2006 10:17:55
	@trigger   SCF B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso

   01/10/2009 21:42:58  v1.1  Ricardo Gonçalves;
      [-] Checagem do status para preenchimento da data e hora de encerramento da classificação
*/
Create or Replace Function mc_00025####???()
Returns trigger As 
$$
Begin
   if tg_op <> 'INSERT' then
      if old.scf_status = 2 then
         raise '[[A classificação % não pode ser alterada porque foi encerrada.]]', new.recno;
      end if;
   end if;

   -- Gera classificação de materiais automaticamento para itens sem rastreabilidade
   if tg_op = 'UPDATE' then
      -- Processamento do encerramento      
	  
      if old.scf_status <> 2 and new.scf_status = 2 then
         new.scf_encerramento:= current_timestamp;
         
         if new.scf_saldo <> 0 or new.scf_saldole <> 0 then
            raise '[[Não foi possível encerrar a classificação % porquê há saldo a distribuir por lote e endereço.]]',
               new.recno;
         end if;
      end if;
   end if;
   
   if tg_op = 'INSERT' then
      new.scf_saldo := new.scf_qtd;
      if mc_00049####???(new.b1_codpro) = 1 and mc_00061####???(new.b1_codpro) = 1 then
		  new.scf_saldole := new.scf_qtd;
      end if;
   end if;

   return new;
End;
$$ language plpgsql;