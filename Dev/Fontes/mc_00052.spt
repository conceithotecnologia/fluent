/**
   Gatilho da tabela de áreas

	@author    Ricardo Gonçalves
	@date      18/07/2014 16:19:00
	@trigger   A4A B IUD

	Histórico
	---------------------------------------------------------------------------------------------------------------------
   Legenda: [-] - Correção / [*] - Recurso modificado/melhorado / [+] - Implementação de recurso
*/
Create or Replace Function mc_00052####???()
Returns trigger As
$$
Declare
   ia4a_bloq   [(a4a)].a4a_bloq%type;   
   r           record;
   bExist      boolean;
   bErro       boolean;
   ilen        int2;
   snivel      varchar;
BEGIN
   if tg_op = 'DELETE' then
      return old;
   end if;
   
   ia4a_bloq := new.a4a_bloq;
      
   if tg_op = 'INSERT' then
      ia4a_bloq := 0;
      new.a4a_bloqtxt := null;
   else
      if old.a4a_nivel != new.a4a_nivel then
         ia4a_bloq:= 1;
         new.a4a_bloqtxt := 'Área bloqueada automaticamente por alteração de nível';
      end if;
      
      -- Verifica se a área de armazenamento pode ser habilitada
      if old.a4a_bloq = 1 and new.a4a_bloq = 0 then
         if not Exists(
            select 1
              from [(sb3)]
             where b3_area = new.recno) 
         then
            raise '[[A área % - % não pode ser desbloqueada porque não tem endereço cadastrado]]', new.recno, new.a4a_nome;
         end if;         
      end if;      
   end if;
   
   new.a4a_bloq := ia4a_bloq;
   
   return new;     
END
$$
language 'plpgsql';